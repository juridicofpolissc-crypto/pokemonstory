<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crime City Detective</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Raleway:wght@400;600;700;900&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      box-sizing: border-box;
      font-family: 'Raleway', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      height: 100%;
      overflow: hidden;
    }

    html {
      height: 100%;
    }

    .app-wrapper {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .game-header {
      background: linear-gradient(135deg, #e94560 0%, #a71d31 100%);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 5px solid #ffd700;
      box-shadow: 0 5px 20px rgba(0,0,0,0.7);
      position: relative;
      z-index: 100;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .badge-logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      border-radius: 50%;
      border: 4px solid #000;
      position: relative;
      box-shadow: 0 0 20px rgba(255,215,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      animation: badgeSpin 4s ease-in-out infinite;
    }

    @keyframes badgeSpin {
      0%, 90% { transform: rotate(0deg); }
      95% { transform: rotate(15deg); }
      100% { transform: rotate(0deg); }
    }

    .game-title {
      font-size: 26px;
      font-weight: 900;
      background: linear-gradient(135deg, #ffd700 0%, #fff 50%, #ffd700 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
      letter-spacing: 2px;
    }

    .player-stats {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .stat-badge {
      background: rgba(0,0,0,0.8);
      padding: 8px 15px;
      border-radius: 20px;
      border: 3px solid #ffd700;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.5);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Raleway', sans-serif;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
      color: #000;
      border: 3px solid #e94560;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
      color: #fff;
      border: 3px solid #ffd700;
    }

    .btn-danger {
      background: linear-gradient(135deg, #e94560 0%, #a71d31 100%);
      color: #fff;
      border: 3px solid #ffd700;
    }

    .btn-success {
      background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
      color: #fff;
      border: 3px solid #ffd700;
    }

    .login-screen {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 600"><rect fill="%231a1a2e" width="1200" height="600"/><circle cx="200" cy="100" r="150" fill="%23e94560" opacity="0.1"/><circle cx="900" cy="400" r="200" fill="%23ffd700" opacity="0.1"/></svg>');
      background-size: cover;
    }

    .login-box {
      background: linear-gradient(135deg, rgba(233,69,96,0.95) 0%, rgba(167,29,49,0.95) 100%);
      padding: 50px;
      border-radius: 25px;
      border: 5px solid #ffd700;
      box-shadow: 0 20px 60px rgba(0,0,0,0.8);
      max-width: 550px;
      width: 100%;
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .login-box h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 28px;
      color: #ffd700;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 10px;
      color: #ffd700;
      font-weight: 700;
      font-size: 16px;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 15px;
      border: 3px solid #ffd700;
      border-radius: 12px;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 16px;
      font-family: 'Raleway', sans-serif;
      transition: all 0.3s;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 15px rgba(74,144,226,0.5);
    }

    .game-screen {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
      padding: 20px;
      overflow: hidden;
    }

    .main-game-area {
      display: flex;
      flex-direction: column;
      gap: 15px;
      overflow: hidden;
    }

    .game-canvas {
      flex: 1;
      background: linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.1) 100%);
      border: 5px solid #ffd700;
      border-radius: 20px;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      padding: 30px;
    }

    .story-panel {
      background: rgba(0,0,0,0.8);
      border: 4px solid #ffd700;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.7);
    }

    .story-title {
      font-size: 24px;
      font-weight: 900;
      color: #ffd700;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }

    .story-text {
      font-size: 16px;
      line-height: 1.8;
      color: #fff;
      margin-bottom: 15px;
    }

    .mystery-box {
      background: linear-gradient(135deg, rgba(233,69,96,0.3) 0%, rgba(167,29,49,0.3) 100%);
      border: 3px solid #e94560;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 0 20px rgba(233,69,96,0.3);
    }

    .mystery-label {
      font-size: 14px;
      color: #ffd700;
      font-weight: 700;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .choices-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }

    .choice-btn {
      background: linear-gradient(135deg, rgba(74,144,226,0.8) 0%, rgba(53,122,189,0.8) 100%);
      border: 3px solid #ffd700;
      border-radius: 12px;
      padding: 18px 25px;
      color: #fff;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
      box-shadow: 0 3px 15px rgba(0,0,0,0.5);
    }

    .choice-btn:hover {
      transform: translateX(10px);
      box-shadow: 0 5px 25px rgba(255,215,0,0.6);
      background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
      color: #000;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 15px;
      overflow-y: auto;
    }

    .panel {
      background: linear-gradient(135deg, rgba(74,144,226,0.95) 0%, rgba(53,122,189,0.95) 100%);
      border: 5px solid #ffd700;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.6);
    }

    .panel h3 {
      color: #ffd700;
      margin-bottom: 15px;
      text-align: center;
      font-size: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .stat-item {
      background: rgba(0,0,0,0.5);
      border: 2px solid #ffd700;
      border-radius: 10px;
      padding: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 900;
      color: #ffd700;
      display: block;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: rgba(0,0,0,0.5);
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #ffd700;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #51cf66 0%, #37b24d 100%);
      transition: width 0.5s;
      box-shadow: 0 0 10px rgba(81,207,102,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: #fff;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .menu-btn {
      padding: 20px;
      background: rgba(0,0,0,0.5);
      border: 3px solid #ffd700;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      font-weight: 700;
      color: #fff;
      font-size: 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }

    .menu-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(255,215,0,0.6);
      background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
      color: #000;
    }

    .menu-icon {
      font-size: 32px;
      margin-bottom: 8px;
      display: block;
    }

    .message-box {
      position: fixed;
      top: 90px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 15px;
      font-weight: 700;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
      z-index: 2000;
      animation: slideInRight 0.3s ease;
      border: 3px solid #ffd700;
      max-width: 400px;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(500px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .message-box.success {
      background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
      color: #fff;
    }

    .message-box.error {
      background: linear-gradient(135deg, #e94560 0%, #a71d31 100%);
      color: #fff;
    }

    .message-box.info {
      background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
      color: #fff;
    }

    .hidden {
      display: none !important;
    }

    .sidebar::-webkit-scrollbar,
    .game-canvas::-webkit-scrollbar {
      width: 10px;
    }

    .sidebar::-webkit-scrollbar-track,
    .game-canvas::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
    }

    .sidebar::-webkit-scrollbar-thumb,
    .game-canvas::-webkit-scrollbar-thumb {
      background: #ffd700;
      border-radius: 10px;
    }

    .case-card {
      background: linear-gradient(135deg, rgba(74,144,226,0.3) 0%, rgba(53,122,189,0.3) 100%);
      border: 3px solid #ffd700;
      border-radius: 15px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .case-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(255,215,0,0.5);
      background: linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,165,0,0.3) 100%);
    }

    .case-title {
      font-size: 18px;
      font-weight: 900;
      color: #ffd700;
      margin-bottom: 10px;
    }

    .case-desc {
      color: #fff;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .case-difficulty {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .case-difficulty.easy {
      background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
      color: #fff;
    }

    .case-difficulty.medium {
      background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
      color: #000;
    }

    .case-difficulty.hard {
      background: linear-gradient(135deg, #ff6b6b 0%, #e94560 100%);
      color: #fff;
    }

    .case-difficulty.extreme {
      background: linear-gradient(135deg, #a71d31 0%, #7a0e21 100%);
      color: #fff;
    }

    .clue-box {
      background: rgba(255,215,0,0.1);
      border: 2px solid #ffd700;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
    }

    .clue-author {
      font-size: 12px;
      color: #ffd700;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .clue-text {
      font-size: 14px;
      color: #fff;
      line-height: 1.6;
    }

    .clue-date {
      font-size: 11px;
      color: #ccc;
      margin-top: 5px;
    }

    .ranking-card {
      background: rgba(0,0,0,0.5);
      border: 3px solid #ffd700;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 20px;
      transition: all 0.3s;
    }

    .ranking-card:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 20px rgba(255,215,0,0.5);
    }

    .ranking-card.top1 {
      border-color: #ffd700;
      background: linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,237,78,0.3) 100%);
      box-shadow: 0 0 30px rgba(255,215,0,0.5);
    }

    .ranking-card.top2 {
      border-color: #c0c0c0;
      background: linear-gradient(135deg, rgba(192,192,192,0.3) 0%, rgba(192,192,192,0.3) 100%);
    }

    .ranking-card.top3 {
      border-color: #cd7f32;
      background: linear-gradient(135deg, rgba(205,127,50,0.3) 0%, rgba(205,127,50,0.3) 100%);
    }

    .ranking-position {
      font-size: 32px;
      font-weight: 900;
      min-width: 60px;
      text-align: center;
    }

    .ranking-position.top1 { color: #ffd700; }
    .ranking-position.top2 { color: #c0c0c0; }
    .ranking-position.top3 { color: #cd7f32; }
    .ranking-position.other { color: #fff; }

    .ranking-info {
      flex: 1;
    }

    .ranking-name {
      font-size: 20px;
      font-weight: 900;
      color: #ffd700;
      margin-bottom: 5px;
    }

    .ranking-stats {
      font-size: 14px;
      color: #fff;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .ranking-medal {
      font-size: 50px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-wrapper">
   <header class="game-header">
    <div class="logo-container">
     <div class="badge-logo">
      üõ°Ô∏è
     </div>
     <div class="game-title" id="game-title">
      üö® CRIME CITY DETECTIVE
     </div>
    </div>
    <div class="player-stats hidden" id="player-stats-header">
     <div class="stat-badge"><span>ÔøΩÔøΩÔøΩÔøΩÔøΩÔ∏è</span> <span id="header-online-time">0h 0m</span>
     </div>
     <div class="stat-badge"><span>‚≠ê</span> <span id="header-rank">Novato</span>
     </div>
     <div class="stat-badge"><span>üîã</span> <span id="header-energy">100</span>
     </div>
     <div class="stat-badge"><span>üí∞</span> <span>$<span id="header-money">0</span></span>
     </div><button class="btn btn-danger" onclick="logout()" style="padding: 8px 16px; font-size: 14px;">Sair</button>
    </div>
   </header>
   <div class="login-screen" id="login-screen">
    <div class="login-box">
     <div style="text-align: center; margin-bottom: 15px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; border: 2px solid #ffd700;">
      <div style="font-size: 18px; font-weight: 900; color: #ffd700; margin-bottom: 3px;" id="login-time">
       00:00:00
      </div>
      <div style="font-size: 11px; color: #fff;" id="login-date">
       Carregando...
      </div>
     </div>
     <h2>üïµÔ∏è BEM-VINDO DETETIVE! üîç</h2>
     <div class="form-group"><label for="login-name">Nome do Investigador:</label> <input type="text" id="login-name" placeholder="Digite seu nome">
     </div>
     <div class="form-group"><label for="login-password">Senha:</label> <input type="password" id="login-password" placeholder="Digite sua senha">
     </div><button class="btn btn-primary" id="login-btn" onclick="login()" style="width: 100%; margin-bottom: 15px;"> üîç ENTRAR NA DELEGACIA </button> <button class="btn btn-secondary" onclick="showRegister()" style="width: 100%;"> ‚ûï NOVO INVESTIGADOR </button>
    </div>
   </div>
   <div class="login-screen hidden" id="register-screen">
    <div class="login-box" style="padding: 30px;">
     <div style="text-align: center; margin-bottom: 8px; background: rgba(0,0,0,0.5); padding: 6px; border-radius: 8px; border: 2px solid #ffd700;">
      <div style="font-size: 14px; font-weight: 900; color: #ffd700; margin-bottom: 2px;" id="register-time">
       00:00:00
      </div>
      <div style="font-size: 9px; color: #fff;" id="register-date">
       Carregando...
      </div>
     </div>
     <h2 style="font-size: 18px; margin-bottom: 10px;">üîç ‚ûï NOVO INVESTIGADOR</h2>
     <div class="form-group" style="margin-bottom: 8px;"><label for="register-name" style="margin-bottom: 4px; font-size: 12px;">Nome do Investigador:</label> <input type="text" id="register-name" placeholder="Digite seu nome" style="padding: 10px; font-size: 14px;">
     </div>
     <div class="form-group" style="margin-bottom: 8px;"><label for="register-password" style="margin-bottom: 4px; font-size: 12px;">Senha:</label> <input type="password" id="register-password" placeholder="Crie uma senha" style="padding: 10px; font-size: 14px;">
     </div>
     <div class="form-group" style="margin-bottom: 8px;"><label for="register-password-confirm" style="margin-bottom: 4px; font-size: 12px;">Confirmar Senha:</label> <input type="password" id="register-password-confirm" placeholder="Confirme sua senha" style="padding: 10px; font-size: 14px;">
     </div>
     <div class="form-group" style="margin-bottom: 8px;"><label for="role-select" style="margin-bottom: 4px; font-size: 12px;">Escolha sua Fun√ß√£o:</label> <select id="role-select" style="padding: 10px; font-size: 14px;"> <option value="detective">üïµÔ∏è Detetive</option> <option value="officer">üëÆ Policial</option> <option value="forensic">üî¨ Perito</option> </select>
     </div><button class="btn btn-primary" id="register-btn" onclick="register()" style="width: 100%; margin-bottom: 8px; padding: 10px 18px; font-size: 14px;"> ‚úÖ REGISTRAR </button> <button class="btn btn-secondary" onclick="showLogin()" style="width: 100%; padding: 10px 18px; font-size: 14px;"> ‚¨ÖÔ∏è VOLTAR </button>
    </div>
   </div>
   <div class="game-screen hidden" id="game-screen">
    <div class="main-game-area">
     <div class="game-canvas" id="game-canvas"><!-- Story content will be loaded here -->
     </div>
    </div>
    <div class="sidebar">
     <div class="panel">
      <h3>üìä SUAS ESTATÔøΩÔøΩÔøΩÔøΩSTICAS</h3>
      <div class="stat-item" style="margin-bottom: 15px; background: linear-gradient(135deg, rgba(74,144,226,0.2) 0%, rgba(53,122,189,0.2) 100%);"><span class="stat-label">TEMPO ONLINE HOJE</span> <span class="stat-value" id="online-time-display" style="font-size: 20px; margin-top: 5px;">‚è±Ô∏è 0h 0m</span>
       <div style="font-size: 11px; color: #ccc; margin-top: 5px;">
        üìö Estudo conta como tempo de trabalho
       </div>
      </div>
      <div class="stat-item" style="margin-bottom: 15px; background: linear-gradient(135deg, rgba(255,215,0,0.2) 0%, rgba(255,165,0,0.2) 100%);"><span class="stat-label">STATUS DE RIQUEZA</span> <span class="stat-value" id="wealth-status-display" style="font-size: 20px; margin-top: 5px;">üí∏ Pobre</span>
       <div style="font-size: 11px; color: #ccc; margin-top: 5px;">
        üí∏ Pobre: $0-$4.999 | üí∞ Rico: $5.000-$19.999 | üíé Magnata: $20.000+
       </div>
      </div>
      <div class="stats-grid">
       <div class="stat-item"><span class="stat-value" id="cases-solved">0</span> <span class="stat-label">Casos Resolvidos</span>
       </div>
       <div class="stat-item"><span class="stat-value" id="arrests-made">0</span> <span class="stat-label">Pris√µes</span>
       </div>
       <div class="stat-item"><span class="stat-value" id="evidence-collected">0</span> <span class="stat-label">Evid√™ncias</span>
       </div>
       <div class="stat-item"><span class="stat-value" id="reputation">0</span> <span class="stat-label">Reputa√ß√£o</span>
       </div>
       <div class="stat-item"><span class="stat-value" id="professor-stars">üéì 0</span> <span class="stat-label">Estrelas Professor</span>
       </div>
      </div>
      <div class="stat-item" style="margin-top: 15px;"><span class="stat-label">Experi√™ncia</span>
       <div class="progress-bar">
        <div class="progress-fill" id="exp-bar" style="width: 0%;">
         0/100
        </div>
       </div>
      </div>
      <div class="stat-item" style="margin-top: 10px;"><span class="stat-label">Energia</span>
       <div class="progress-bar">
        <div class="progress-fill" id="energy-bar" style="background: linear-gradient(90deg, #4a90e2 0%, #357abd 100%); width: 100%;">
         100/100
        </div>
       </div>
      </div>
     </div>
     <div class="panel">
      <h3>‚ö° MENU R√ÅPIDO</h3>
      <div class="menu-grid">
       <div class="menu-btn" onclick="openCaseFiles()"><span class="menu-icon">üìÅ</span> Casos
       </div>
       <div class="menu-btn" onclick="showCaseLocations()"><span class="menu-icon">üó∫Ô∏è</span> Locais
       </div>
       <div class="menu-btn" onclick="openRanking()"><span class="menu-icon">üèÜ</span> Ranking
       </div>
       <div class="menu-btn" onclick="openStudy()"><span class="menu-icon">üìö</span> Estudar
       </div>
       <div class="menu-btn" onclick="openWorkShift()"><span class="menu-icon">‚è∞</span> Trabalhar
       </div>
       <div class="menu-btn" onclick="openTeamManagement()"><span class="menu-icon">üë•</span> Equipe
       </div>
      </div>
     </div>
     <div class="panel" id="current-case-panel">
      <h3>üîé CASO ATUAL</h3>
      <div id="current-case-display">
       <p style="text-align: center; color: #ccc;">Nenhum caso ativo</p>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    let currentPlayer = null;
    let allPlayers = [];
    let locationClues = JSON.parse(localStorage.getItem('locationClues') || '{}');
    let sessionStartTime = null;
    let onlineTimeInterval = null;

    const defaultConfig = {
      game_title: "CRIME CITY DETECTIVE"
    };

    async function onConfigChange(config) {
      document.getElementById('game-title').textContent = config.game_title || defaultConfig.game_title;
    }

    async function init() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig: defaultConfig,
          onConfigChange: onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["game_title", config.game_title || defaultConfig.game_title]
          ])
        });
      }

      setTimeout(() => tryAutoLogin(), 500);
    }

    function startOnlineTimeTracking() {
      sessionStartTime = Date.now();
      
      if (onlineTimeInterval) {
        clearInterval(onlineTimeInterval);
      }
      
      onlineTimeInterval = setInterval(() => {
        updateOnlineTime();
      }, 60000);
      
      updateOnlineTime();
    }

    function updateOnlineTime() {
      if (!sessionStartTime || !currentPlayer) return;
      
      const sessionTime = Date.now() - sessionStartTime;
      const totalOnlineToday = (currentPlayer.onlineTimeToday || 0) + sessionTime;
      
      const hours = Math.floor(totalOnlineToday / (1000 * 60 * 60));
      const minutes = Math.floor((totalOnlineToday % (1000 * 60 * 60)) / (1000 * 60));
      
      const display = `‚è±Ô∏è ${hours}h ${minutes}m`;
      
      const headerDisplay = document.getElementById('header-online-time');
      const sidebarDisplay = document.getElementById('online-time-display');
      
      if (headerDisplay) headerDisplay.textContent = `${hours}h ${minutes}m`;
      if (sidebarDisplay) sidebarDisplay.textContent = display;
    }

    function saveOnlineTime() {
      if (!sessionStartTime || !currentPlayer) return;
      
      const sessionTime = Date.now() - sessionStartTime;
      
      const today = new Date().toDateString();
      if (currentPlayer.lastOnlineDate !== today) {
        currentPlayer.onlineTimeToday = 0;
        currentPlayer.lastOnlineDate = today;
      }
      
      currentPlayer.onlineTimeToday = (currentPlayer.onlineTimeToday || 0) + sessionTime;
      currentPlayer.totalOnlineTime = (currentPlayer.totalOnlineTime || 0) + sessionTime;
      
      savePlayerData();
      sessionStartTime = Date.now();
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function showRegister() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.remove('hidden');
    }

    function showLogin() {
      document.getElementById('register-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
    }

    function login() {
      const name = document.getElementById('login-name').value.trim();
      const password = document.getElementById('login-password').value;

      if (!name || !password) {
        showMessage('‚ùå Preencha todos os campos!', 'error');
        return;
      }

      const existingPlayers = JSON.parse(localStorage.getItem('players') || '[]');
      const player = existingPlayers.find(p => p.name.toLowerCase() === name.toLowerCase() && p.password === password);

      if (!player) {
        showMessage('‚ùå Nome ou senha incorretos!', 'error');
        return;
      }

      player.lastLogin = new Date().toISOString();
      
      const today = new Date().toDateString();
      if (player.lastOnlineDate !== today) {
        player.onlineTimeToday = 0;
        player.lastOnlineDate = today;
        player.dailyStudyCompleted = false;
      }
      
      localStorage.setItem('currentPlayer', JSON.stringify(player));
      
      const playerIndex = existingPlayers.findIndex(p => p.id === player.id);
      existingPlayers[playerIndex] = player;
      localStorage.setItem('players', JSON.stringify(existingPlayers));

      showMessage('‚úÖ Bem-vindo de volta, ' + player.name + '!', 'success');

      setTimeout(() => {
        currentPlayer = player;
        allPlayers = existingPlayers;
        enterGame();
      }, 1000);
    }

    function register() {
      const name = document.getElementById('register-name').value.trim();
      const password = document.getElementById('register-password').value;
      const passwordConfirm = document.getElementById('register-password-confirm').value;
      const role = document.getElementById('role-select').value;

      if (!name) {
        showMessage('‚ùå Digite um nome para o investigador!', 'error');
        return;
      }

      if (name.length < 3) {
        showMessage('‚ùå O nome deve ter pelo menos 3 caracteres!', 'error');
        return;
      }

      if (!password) {
        showMessage('‚ùå Digite uma senha!', 'error');
        return;
      }

      if (password.length < 4) {
        showMessage('‚ùå A senha deve ter pelo menos 4 caracteres!', 'error');
        return;
      }

      if (password !== passwordConfirm) {
        showMessage('‚ùå As senhas n√£o coincidem!', 'error');
        return;
      }

      const existingPlayers = JSON.parse(localStorage.getItem('players') || '[]');
      if (existingPlayers.find(p => p.name.toLowerCase() === name.toLowerCase())) {
        showMessage('‚ùå J√° existe um investigador com esse nome!', 'error');
        return;
      }

      const newPlayer = {
        id: Date.now().toString(),
        name: name,
        password: password,
        role: role,
        rank: 'Novato',
        level: 1,
        exp: 0,
        energy: 100,
        maxEnergy: 100,
        money: 500,
        reputation: 0,
        casesSolved: 0,
        arrestsMade: 0,
        evidenceCollected: 0,
        professorStars: 0,
        inventory: JSON.stringify([]),
        location: JSON.stringify([]),
        activeCase: null,
        activeWorkShift: null,
        workHistory: [],
        dailyStudyCompleted: false,
        onlineTimeToday: 0,
        totalOnlineTime: 0,
        lastOnlineDate: new Date().toDateString(),
        createdAt: new Date().toISOString(),
        lastLogin: new Date().toISOString()
      };

      existingPlayers.push(newPlayer);
      localStorage.setItem('players', JSON.stringify(existingPlayers));
      localStorage.setItem('currentPlayer', JSON.stringify(newPlayer));

      showMessage('‚úÖ Investigador registrado com sucesso!', 'success');

      setTimeout(() => {
        currentPlayer = newPlayer;
        allPlayers = existingPlayers;
        enterGame();
      }, 1000);
    }

    function enterGame() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('register-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.remove('hidden');
      document.getElementById('player-stats-header').classList.remove('hidden');
      
      startOnlineTimeTracking();
      updateUI();
      updateCurrentCaseDisplay();
      loadWelcomeStory();
      
      if (currentPlayer.activeWorkShift) {
        const now = Date.now();
        if (now >= currentPlayer.activeWorkShift.endTime) {
          completeWorkShift();
        }
      }
    }

    function logout() {
      saveOnlineTime();
      
      if (onlineTimeInterval) {
        clearInterval(onlineTimeInterval);
        onlineTimeInterval = null;
      }
      
      localStorage.removeItem('currentPlayer');
      currentPlayer = null;
      sessionStartTime = null;
      
      document.getElementById('game-screen').classList.add('hidden');
      document.getElementById('player-stats-header').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      
      document.getElementById('login-name').value = '';
      document.getElementById('login-password').value = '';
      
      showMessage('üëã At√© logo, detetive!', 'info');
    }

    setInterval(() => {
      if (currentPlayer && sessionStartTime) {
        saveOnlineTime();
      }
    }, 300000);

    window.addEventListener('beforeunload', () => {
      if (currentPlayer && sessionStartTime) {
        saveOnlineTime();
      }
    });

    function openWorkShift() {
      if (currentPlayer.activeWorkShift) {
        const now = Date.now();
        if (now >= currentPlayer.activeWorkShift.endTime) {
          completeWorkShift();
          return;
        } else {
          showWorkShiftProgress();
          return;
        }
      }
      
      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">‚è∞</div>
          <div class="story-title">‚è∞ CENTRAL DE TRABALHO</div>
          <div class="story-text">
            <p>Escolha como deseja trabalhar hoje, detetive!</p>
            <p style="color: #ffd700;">Seu cargo: <strong>${getRoleName(currentPlayer.role)}</strong></p>
            <p style="color: #4a90e2; margin-top: 10px;">‚è±Ô∏è Tempo online hoje: <strong>${formatOnlineTime(currentPlayer.onlineTimeToday || 0)}</strong></p>
          </div>
          
          <div style="display: grid; gap: 15px; margin-top: 20px;">
            <div class="case-card" onclick="showWorkShifts()" style="cursor: pointer;">
              <div class="case-title">ÔøΩÔøΩ TURNOS DE TRABALHO (COM GPS)</div>
              <div class="case-desc">Fa√ßa check-in em locais de trabalho e cumpra turnos para ganhar sal√°rio!</div>
              <div style="margin-top: 10px; color: #51cf66; font-size: 13px;">üìç Requer localiza√ß√£o | üí∞ Sal√°rio garantido | üîã Recupera energia</div>
            </div>
            
            <div class="case-card" onclick="showEmergencyCalls()" style="cursor: pointer;">
              <div class="case-title">üö® CHAMADOS DE EMERG√äNCIA (COM GPS)</div>
              <div class="case-desc">Atenda ocorr√™ncias r√°pidas pela cidade. V√° at√© o local!</div>
              <div style="margin-top: 10px; color: #ffd700; font-size: 13px;">üìç Requer localiza√ß√£o | ‚ö° Resolu√ß√£o r√°pida | üíµ Dinheiro imediato</div>
            </div>
            
            <div class="case-card" onclick="showAdminWork()" style="cursor: pointer;">
              <div class="case-title">üìã TRABALHO ADMINISTRATIVO</div>
              <div class="case-desc">Tarefas internas da delegacia: arquivos, treinamento e estudos.</div>
              <div style="margin-top: 10px; color: #4a90e2; font-size: 13px;">üìö Ganhe EXP | üèÖ Aumente reputa√ß√£o</div>
            </div>
            
            <div class="case-card" onclick="showRestOptions()" style="cursor: pointer;">
              <div class="case-title">üò¥ DESCANSO E RECUPERA√á√ÉO</div>
              <div class="case-desc">Descanse para recuperar energia mais rapidamente.</div>
              <div style="margin-top: 10px; color: #51cf66; font-size: 13px;">üîã Recupera energia | ‚è±Ô∏è Baseado no tempo</div>
            </div>
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            <button class="choice-btn" onclick="loadWelcomeStory()">‚¨ÖÔ∏è VOLTAR</button>
          </div>
        </div>
      `;
    }

    function formatOnlineTime(milliseconds) {
      const hours = Math.floor(milliseconds / (1000 * 60 * 60));
      const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
      return `${hours}h ${minutes}m`;
    }

    function showWorkShifts() {
      const workLocations = getWorkLocations();
      const canvas = document.getElementById('game-canvas');
      
      let locationsHTML = workLocations.map(loc => `
        <div class="case-card" onclick="selectWorkLocation('${loc.id}')" style="cursor: pointer;">
          <div class="case-title">${loc.name}</div>
          <div class="case-desc" style="font-size: 12px; color: #ccc; margin-bottom: 10px;">
            üìç ${loc.address}
          </div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px;">
            <div style="background: rgba(255,215,0,0.2); padding: 8px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; color: #ffd700;">4 HORAS</div>
              <div style="font-size: 14px; font-weight: 700; color: #fff;">$${loc.salary_4h}</div>
            </div>
            <div style="background: rgba(255,215,0,0.2); padding: 8px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; color: #ffd700;">8 HORAS</div>
              <div style="font-size: 14px; font-weight: 700; color: #fff;">$${loc.salary_8h}</div>
            </div>
            <div style="background: rgba(255,215,0,0.2); padding: 8px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; color: #ffd700;">12 HORAS</div>
              <div style="font-size: 14px; font-weight: 700; color: #fff;">$${loc.salary_12h}</div>
            </div>
            <div style="background: rgba(255,215,0,0.3); padding: 8px; border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; color: #ffd700;">24 HORAS</div>
              <div style="font-size: 14px; font-weight: 700; color: #fff;">$${loc.salary_24h}</div>
            </div>
          </div>
        </div>
      `).join('');
      
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">üíº</div>
          <div class="story-title">üíº ESCOLHA O LOCAL DE TRABALHO</div>
          <div class="story-text">
            <p>Escolha onde deseja trabalhar e fazer check-in!</p>
            <p style="color: #ffd700;">Seu cargo: <strong>${getRoleName(currentPlayer.role)}</strong></p>
            <p style="color: #51cf66; font-size: 13px; margin-top: 10px;">‚ö†Ô∏è Voc√™ precisar√° estar a menos de 500m do local para fazer check-in</p>
          </div>
          
          <div style="display: grid; gap: 15px; margin-top: 20px; max-height: 500px; overflow-y: auto;">
            ${locationsHTML}
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            <button class="choice-btn" onclick="openWorkShift()">‚¨ÖÔ∏è VOLTAR</button>
          </div>
        </div>
      `;
    }

    function getWorkLocations() {
      const salaries = {
        detective: { base_4h: 400, base_8h: 900, base_12h: 1500, base_24h: 3200 },
        officer: { base_4h: 300, base_8h: 700, base_12h: 1200, base_24h: 2600 },
        forensic: { base_4h: 450, base_8h: 1000, base_12h: 1700, base_24h: 3600 }
      };
      
      const base = salaries[currentPlayer.role] || salaries.detective;
      
      return [
        {
          id: 'delegacia-centro',
          name: 'üöî Delegacia Central',
          address: 'Rua Saldanha Marinho, Centro',
          lat: -27.5920,
          lng: -48.5480,
          salary_4h: base.base_4h,
          salary_8h: base.base_8h,
          salary_12h: base.base_12h,
          salary_24h: base.base_24h
        },
        {
          id: 'shopping-beiramar',
          name: 'ÔøΩÔøΩ Posto Shopping Beiramar',
          address: 'Rua Bocai√∫va, 2468, Centro',
          lat: -27.5940,
          lng: -48.5519,
          salary_4h: Math.floor(base.base_4h * 1.1),
          salary_8h: Math.floor(base.base_8h * 1.1),
          salary_12h: Math.floor(base.base_12h * 1.1),
          salary_24h: Math.floor(base.base_24h * 1.1)
        },
        {
          id: 'aeroporto',
          name: '‚úàÔ∏è Posto Aeroporto',
          address: 'Av. Dep. Diom√≠cio Freitas, Carianos',
          lat: -27.6703,
          lng: -48.5472,
          salary_4h: Math.floor(base.base_4h * 1.2),
          salary_8h: Math.floor(base.base_8h * 1.2),
          salary_12h: Math.floor(base.base_12h * 1.2),
          salary_24h: Math.floor(base.base_24h * 1.2)
        },
        {
          id: 'lagoa-posto',
          name: 'üåä Posto Lagoa da Concei√ß√£o',
          address: 'Av. das Rendeiras, Lagoa',
          lat: -27.5969,
          lng: -48.4519,
          salary_4h: base.base_4h,
          salary_8h: base.base_8h,
          salary_12h: base.base_12h,
          salary_24h: base.base_24h
        }
      ];
    }

    function selectWorkLocation(locationId) {
      const locations = getWorkLocations();
      const location = locations.find(l => l.id === locationId);
      if (!location) return;
      
      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">üìç</div>
          <div class="story-title">${location.name}</div>
          <div class="story-text">
            <p>üìç <strong>Endere√ßo:</strong> ${location.address}</p>
            <p style="color: #ffd700; margin-top: 15px;">Escolha a dura√ß√£o do seu turno:</p>
          </div>
          
          <div style="display: grid; gap: 12px; margin-top: 20px;">
            <div class="case-card" onclick="startWorkShift('${locationId}', 4, ${location.salary_4h}, 15)" style="cursor: pointer;">
              <div class="case-title">‚è∞ TURNO DE 4 HORAS</div>
              <div class="case-desc">Meio per√≠odo de trabalho</div>
              <div style="margin-top: 10px; color: #ffd700;">üí∞ +$${location.salary_4h} | üîã +15 energia | ‚è±Ô∏è 4h</div>
            </div>
            
            <div class="case-card" onclick="startWorkShift('${locationId}', 8, ${location.salary_8h}, 35)" style="cursor: pointer;">
              <div class="case-title">‚è∞ TURNO DE 8 HORAS</div>
              <div class="case-desc">Turno padr√£o de trabalho</div>
              <div style="margin-top: 10px; color: #ffd700;">üí∞ +$${location.salary_8h} | üîã +35 energia | ‚è±Ô∏è 8h</div>
            </div>
            
            <div class="case-card" onclick="startWorkShift('${locationId}', 12, ${location.salary_12h}, 55)" style="cursor: pointer;">
              <div class="case-title">‚è∞ TURNO DE 12 HORAS</div>
              <div class="case-desc">Turno estendido com hora extra</div>
              <div style="margin-top: 10px; color: #ffd700;">üí∞ +$${location.salary_12h} | üîã +55 energia | ‚è±Ô∏è 12h</div>
            </div>
            
            <div class="case-card" onclick="startWorkShift('${locationId}', 24, ${location.salary_24h}, 100)" style="cursor: pointer; background: linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,165,0,0.3) 100%);">
              <div class="case-title">‚è∞ PLANT√ÉO 24 HORAS</div>
              <div class="case-desc">Plant√£o completo - m√°ximo ganho!</div>
              <div style="margin-top: 10px; color: #ffd700;">üí∞ +$${location.salary_24h} | üîã +100 (FULL) | ‚è±Ô∏è 24h</div>
            </div>
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            <button class="choice-btn" onclick="showWorkShifts()">ÔøΩÔøΩÔøΩÔ∏è VOLTAR</button>
          </div>
        </div>
      `;
    }

    function startWorkShift(locationId, hours, salary, energy) {
      const locations = getWorkLocations();
      const location = locations.find(l => l.id === locationId);
      if (!location) return;
      
      if (!navigator.geolocation) {
        showMessage('‚ùå Seu navegador n√£o suporta geolocaliza√ß√£o!', 'error');
        return;
      }
      
      showMessage('üìç Verificando sua localiza√ß√£o...', 'info');
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          const distance = calculateDistance(userLat, userLng, location.lat, location.lng);
          const maxDistance = 500;
          
          if (distance > maxDistance) {
            const distanceKm = (distance / 1000).toFixed(2);
            showMessage(`‚ùå Muito longe! Dist√¢ncia: ${distanceKm}km. Precisa estar a menos de 500m.`, 'error');
            return;
          }
          
          currentPlayer.activeWorkShift = {
            locationId: locationId,
            locationName: location.name,
            hours: hours,
            salary: salary,
            energy: energy,
            startTime: Date.now(),
            endTime: Date.now() + (hours * 60 * 60 * 1000)
          };
          
          savePlayerData();
          showMessage(`ÔøΩÔøΩÔøΩ Check-in realizado! Turno de ${hours}h iniciado.`, 'success');
          showWorkShiftProgress();
        },
        (error) => {
          let errorMsg = '‚ùå N√£o foi poss√≠vel obter sua localiza√ß√£o. ';
          if (error.code === error.PERMISSION_DENIED) {
            errorMsg += 'Permita o acesso √† localiza√ß√£o.';
          }
          showMessage(errorMsg, 'error');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function showWorkShiftProgress() {
      if (!currentPlayer.activeWorkShift) {
        showMessage('‚ùå Nenhum turno ativo!', 'error');
        openWorkShift();
        return;
      }
      
      const shift = currentPlayer.activeWorkShift;
      const now = Date.now();
      const elapsed = now - shift.startTime;
      const remaining = shift.endTime - now;
      
      if (remaining <= 0) {
        completeWorkShift();
        return;
      }
      
      const elapsedHours = Math.floor(elapsed / (1000 * 60 * 60));
      const elapsedMinutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
      const remainingHours = Math.floor(remaining / (1000 * 60 * 60));
      const remainingMinutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
      
      const progressPercent = (elapsed / (shift.hours * 60 * 60 * 1000)) * 100;
      
      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">‚è∞</div>
          <div class="story-title">üíº TURNO EM ANDAMENTO</div>
          <div class="story-text">
            <p><strong>${shift.locationName}</strong></p>
            <p style="color: #ffd700; margin-top: 10px;">Turno de ${shift.hours} horas</p>
          </div>
          
          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(74,144,226,0.3) 0%, rgba(53,122,189,0.3) 100%);">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div style="text-align: center;">
                <div style="font-size: 11px; color: #ffd700;">TEMPO TRABALHADO</div>
                <div style="font-size: 24px; font-weight: 900; color: #fff; margin-top: 5px;">
                  ${elapsedHours}h ${elapsedMinutes}m
                </div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 11px; color: #ffd700;">TEMPO RESTANTE</div>
                <div style="font-size: 24px; font-weight: 900; color: #fff; margin-top: 5px;">
                  ${remainingHours}h ${remainingMinutes}m
                </div>
              </div>
            </div>
            
            <div class="progress-bar" style="height: 20px;">
              <div class="progress-fill" style="width: ${progressPercent}%; background: linear-gradient(90deg, #ffd700 0%, #ffa500 100%);">
                ${Math.round(progressPercent)}%
              </div>
            </div>
          </div>
          
          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(81,207,102,0.3) 0%, rgba(55,178,77,0.3) 100%); border-color: #51cf66; margin-top: 15px;">
            <div class="mystery-label" style="color: #51cf66;">ÔøΩÔøΩÔøΩÔøΩ RECOMPENSAS AO CONCLUIR</div>
            <div style="color: #fff; font-size: 16px; margin-top: 10px;">
              <p>üíµ Sal√°rio: <strong style="color: #ffd700;">$${shift.salary}</strong></p>
              <p>üîã Energia: <strong style="color: #51cf66;">+${shift.energy}</strong></p>
              <p>‚≠ê Experi√™ncia: <strong style="color: #4a90e2;">+${shift.hours * 5} EXP</strong></p>
            </div>
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            <button class="choice-btn" onclick="showWorkShiftProgress()" style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); color: #000;">
              üîÑ ATUALIZAR PROGRESSO
            </button>
            <button class="choice-btn" onclick="cancelWorkShift()">
              ‚ùå CANCELAR TURNO (sem recompensas)
            </button>
            <button class="choice-btn" onclick="loadWelcomeStory()">
              üè† VOLTAR (turno continua)
            </button>
          </div>
        </div>
      `;
      
      setTimeout(() => {
        if (currentPlayer.activeWorkShift && currentPlayer.activeWorkShift.locationId === shift.locationId) {
          showWorkShiftProgress();
        }
      }, 60000);
    }

    function completeWorkShift() {
      if (!currentPlayer.activeWorkShift) return;
      
      const shift = currentPlayer.activeWorkShift;
      currentPlayer.money += shift.salary;
      currentPlayer.energy = Math.min(currentPlayer.maxEnergy, currentPlayer.energy + shift.energy);
      currentPlayer.exp += shift.hours * 5;
      
      const shiftRecord = {
        locationId: shift.locationId,
        locationName: shift.locationName,
        hours: shift.hours,
        salary: shift.salary,
        completedAt: new Date().toISOString()
      };
      
      if (!currentPlayer.workHistory) {
        currentPlayer.workHistory = [];
      }
      currentPlayer.workHistory.push(shiftRecord);
      
      currentPlayer.activeWorkShift = null;
      savePlayerData();
      updateUI();
      
      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 80px; margin-bottom: 20px;">üéâ</div>
          <div class="story-title">üíº TURNO CONCLUÔøΩÔøΩDO!</div>
          <div class="story-text">
            <p>Parab√©ns! Voc√™ completou o turno de <strong>${shift.hours} horas</strong> em:</p>
            <p style="color: #ffd700; font-size: 18px; margin-top: 10px;"><strong>${shift.locationName}</strong></p>
          </div>
          
          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(81,207,102,0.3) 0%, rgba(55,178,77,0.3) 100%); border-color: #51cf66;">
            <div class="mystery-label" style="color: #51cf66;">üí∞ RECOMPENSAS RECEBIDAS</div>
            <div style="color: #fff; font-size: 18px; margin-top: 15px;">
              <p>üíµ Sal√°rio: <strong style="color: #ffd700;">+$${shift.salary}</strong></p>
              <p>üîã Energia: <strong style="color: #51cf66;">+${shift.energy}</strong></p>
              <p>‚≠ê Experi√™ncia: <strong style="color: #4a90e2;">+${shift.hours * 5} EXP</strong></p>
            </div>
          </div>

          <div class="choices-container" style="margin-top: 25px;">
            <button class="choice-btn" onclick="showWorkShifts()" style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); color: #000;">
              üíº NOVO TURNO
            </button>
            <button class="choice-btn" onclick="loadWelcomeStory()">
              üè† VOLTAR AO IN√çCIO
            </button>
          </div>
        </div>
      `;
    }

    function cancelWorkShift() {
      if (!currentPlayer.activeWorkShift) return;
      
      const shiftName = currentPlayer.activeWorkShift.locationName;
      currentPlayer.activeWorkShift = null;
      savePlayerData();
      
      showMessage(`‚ùå Turno em ${shiftName} cancelado!`, 'error');
      setTimeout(() => openWorkShift(), 1000);
    }

    function showEmergencyCalls() {
      const calls = [
        {
          id: 'call01',
          title: 'üöó Acidente de Tr√¢nsito',
          desc: 'Colis√£o leve na Beira-Mar Norte',
          location: 'Av. Beira-Mar Norte, pr√≥ximo ao CIC',
          lat: -27.5940,
          lng: -48.5519,
          reward: 200,
          exp: 20,
          energy: 5
        },
        {
          id: 'call02',
          title: 'üëä Briga em Bar',
          desc: 'Confus√£o entre clientes no Centro',
          location: 'Bar na Rua Felipe Schmidt, Centro',
          lat: -27.5949,
          lng: -48.5502,
          reward: 180,
          exp: 18,
          energy: 5
        },
        {
          id: 'call03',
          title: 'üîä Perturba√ß√£o Noturna',
          desc: 'Festa com som alto na Lagoa',
          location: 'Centrinho da Lagoa da Concei√ß√£o',
          lat: -27.5969,
          lng: -48.4519,
          reward: 150,
          exp: 15,
          energy: 3
        },
        {
          id: 'call04',
          title: 'üêï Animal Perdido',
          desc: 'Cachorro perdido na Barra da Lagoa',
          location: 'Orla da Barra da Lagoa',
          lat: -27.5742,
          lng: -48.4183,
          reward: 120,
          exp: 12,
          energy: 3
        },
        {
          id: 'call05',
          title: 'üöó Ve√≠culo Suspeito',
          desc: 'Carro abandonado no Aeroporto',
          location: 'Estacionamento do Aeroporto',
          lat: -27.6703,
          lng: -48.5472,
          reward: 160,
          exp: 16,
          energy: 4
        },
        {
          id: 'call06',
          title: 'üí• Dano ao Patrim√¥nio',
          desc: 'Vidro de loja quebrado no Centro',
          location: 'Rua Conselheiro Mafra, Centro',
          lat: -27.5969,
          lng: -48.5495,
          reward: 190,
          exp: 19,
          energy: 5
        },
        {
          id: 'call07',
          title: 'üì± Celular Furtado',
          desc: 'Turista teve celular roubado',
          location: 'Pra√ßa XV de Novembro',
          lat: -27.5969,
          lng: -48.5480,
          reward: 170,
          exp: 17,
          energy: 4
        },
        {
          id: 'call08',
          title: 'üë§ Pessoa Suspeita',
          desc: 'Indiv√≠duo agindo estranhamente',
          location: 'Orla da Lagoa da Concei√ß√£o',
          lat: -27.6000,
          lng: -48.4550,
          reward: 140,
          exp: 14,
          energy: 3
        }
      ];

      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align:center;font-size:60px;margin-bottom:15px;">üö®</div>
          <div class="story-title">üö® CHAMADOS DE EMERG√äNCIA</div>
          <div class="story-text">
            <p>Atenda ocorr√™ncias r√°pidas pela cidade!</p>
            <p style="color: #ffd700;">Sua energia: <strong>${currentPlayer.energy}/${currentPlayer.maxEnergy}</strong></p>
            <p style="color: #51cf66; font-size: 13px; margin-top: 10px;">‚ö†Ô∏è Voc√™ precisa ir at√© o local (500m) para atender o chamado</p>
          </div>
          
          <div style="display:grid;gap:12px;margin-top:20px;max-height:500px;overflow-y:auto;">
            ${calls.map(call => `
              <div class="case-card" onclick='selectEmergencyCall(${JSON.stringify(call)})' style="cursor:pointer;">
                <div class="case-title">${call.title}</div>
                <div class="case-desc">${call.desc}</div>
                <div style="font-size: 12px; color: #ccc; margin-top: 8px;">
                  üìç ${call.location}
                </div>
                <div style="margin-top:10px;display:flex;justify-content:space-between;font-size:13px;">
                  <span style="color:#ffd700;">üí∞ $${call.reward}</span>
                  <span style="color:#51cf66;">‚≠ê +${call.exp}</span>
                  <span style="color:#e94560;">üîã -${call.energy}</span>
                </div>
              </div>
            `).join('')}
          </div>

          <div class="choices-container" style="margin-top:20px;">
            <button class="choice-btn" onclick="openWorkShift()">‚¨ÖÔ∏è VOLTAR</button>
          </div>
        </div>
      `;
    }

    function selectEmergencyCall(call) {
      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align:center;font-size:60px;margin-bottom:15px;">üö®</div>
          <div class="story-title">${call.title}</div>
          <div class="story-text">
            <p>${call.desc}</p>
            <p style="color: #ffd700; margin-top: 15px;"><strong>üìç Local:</strong> ${call.location}</p>
            <p style="color: #51cf66; font-size: 13px; margin-top: 10px;">
              ‚ö†Ô∏è Voc√™ precisa estar a menos de 500m do local para fazer check-in
            </p>
          </div>
          
          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(81,207,102,0.3) 0%, rgba(55,178,77,0.3) 100%); border-color: #51cf66;">
            <div class="mystery-label" style="color: #51cf66;">üí∞ RECOMPENSAS</div>
            <div style="color: #fff; font-size: 16px; margin-top: 10px;">
              <p>üíµ Dinheiro: <strong style="color: #ffd700;">$${call.reward}</strong></p>
              <p>‚≠ê Experi√™ncia: <strong style="color: #51cf66;">+${call.exp} EXP</strong></p>
              <p>üèÖ Reputa√ß√£o: <strong style="color: #4a90e2;">+${Math.floor(call.exp / 5)}</strong></p>
              <p style="color: #e94560;">üîã Custo: <strong>-${call.energy} energia</strong></p>
            </div>
          </div>

          <div class="choices-container" style="margin-top:20px;">
            <button class="choice-btn" onclick='resolveCall(${JSON.stringify(call)})' style="background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: #fff;">
              üìç FAZER CHECK-IN E ATENDER
            </button>
            <button class="choice-btn" onclick="showEmergencyCalls()">
              ‚¨ÖÔ∏è VOLTAR
            </button>
          </div>
        </div>
      `;
    }

    function resolveCall(call) {
      if (currentPlayer.energy < call.energy) {
        showMessage('‚ùå Energia insuficiente!', 'error');
        return;
      }

      if (!navigator.geolocation) {
        showMessage('‚ùå Seu navegador n√£o suporta geolocaliza√ß√£o!', 'error');
        return;
      }

      showMessage('üìç Verificando sua localiza√ß√£o...', 'info');

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          const distance = calculateDistance(userLat, userLng, call.lat, call.lng);
          const maxDistance = 500;

          if (distance > maxDistance) {
            const distanceKm = (distance / 1000).toFixed(2);
            showMessage(`‚ùå Muito longe! Dist√¢ncia: ${distanceKm}km. Precisa estar a menos de 500m do local.`, 'error');
            return;
          }

          currentPlayer.money += call.reward;
          currentPlayer.exp += call.exp;
          currentPlayer.energy -= call.energy;
          currentPlayer.reputation += Math.floor(call.exp / 5);
          savePlayerData();
          updateUI();

          showMessage(`‚úÖ Check-in realizado! Chamado resolvido! +$${call.reward} | +${call.exp} EXP`, 'success');

          const canvas = document.getElementById('game-canvas');
          canvas.innerHTML = `
            <div class="story-panel">
              <div style="text-align:center;font-size:80px;margin-bottom:20px;">üéâ</div>
              <div class="story-title">‚úÖ CHAMADO ATENDIDO!</div>
              <div class="story-text">
                <p>Voc√™ chegou ao local e resolveu a ocorr√™ncia com sucesso!</p>
                <p style="color: #ffd700; font-size: 18px; margin-top: 10px;"><strong>${call.title}</strong></p>
                <p style="color: #ccc; font-size: 14px; margin-top: 5px;">üìç ${call.location}</p>
              </div>

              <div class="mystery-box" style="background: linear-gradient(135deg, rgba(81,207,102,0.3) 0%, rgba(55,178,77,0.3) 100%); border-color: #51cf66;">
                <div class="mystery-label" style="color: #51cf66;">üí∞ RECOMPENSAS RECEBIDAS</div>
                <div style="color: #fff; font-size: 18px; margin-top: 15px;">
                  <p>üíµ Dinheiro: <strong style="color: #ffd700;">+$${call.reward}</strong></p>
                  <p>‚≠ê Experi√™ncia: <strong style="color: #51cf66;">+${call.exp} EXP</strong></p>
                  <p>üèÖ Reputa√ß√£o: <strong style="color: #4a90e2;">+${Math.floor(call.exp / 5)}</strong></p>
                </div>
              </div>

              <div class="choices-container" style="margin-top:25px;">
                <button class="choice-btn" onclick="showEmergencyCalls()" style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); color: #000;">
                  üö® PR√ìXIMO CHAMADO
                </button>
                <button class="choice-btn" onclick="openWorkShift()">
                  ‚¨ÖÔ∏è VOLTAR AO MENU
                </button>
              </div>
            </div>
          `;
        },
        (error) => {
          let errorMsg = '‚ùå N√£o foi poss√≠vel obter sua localiza√ß√£o. ';
          if (error.code === error.PERMISSION_DENIED) {
            errorMsg += 'Permita o acesso √† localiza√ß√£o.';
          } else if (error.code === error.POSITION_UNAVAILABLE) {
            errorMsg += 'Localiza√ß√£o indispon√≠vel.';
          } else if (error.code === error.TIMEOUT) {
            errorMsg += 'Tempo esgotado. Tente novamente.';
          }
          showMessage(errorMsg, 'error');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

function showAdminWork(){const c=document.getElementById('game-canvas');c.innerHTML=`<div class="story-panel"><div style="text-align:center;font-size:60px;margin-bottom:15px;">üìã</div><div class="story-title">üìã TRABALHO ADMINISTRATIVO</div><div class="story-text"><p>Colete documentos e provas em bibliotecas e supermercados!</p><p style="color: #ffd700;">Voc√™ precisa ir at√© os locais para coletar os pap√©is!</p></div><div style="display:grid;gap:12px;margin-top:20px;"><div class="case-card" onclick="showDocumentLocations()" style="cursor:pointer; background: linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,165,0,0.3) 100%);"><div class="case-title">üìÑ COLETAR DOCUMENTOS (COM GPS)</div><div class="case-desc">V√° at√© bibliotecas e supermercados para coletar pap√©is e provas</div><div style="margin-top:10px;color:#ffd700;">üìç Requer localiza√ß√£o | üí∞ Dinheiro | ‚≠ê Experi√™ncia</div></div><div class="case-card" onclick="showTrainingLocations()" style="cursor:pointer; background: linear-gradient(135deg, rgba(74,144,226,0.3) 0%, rgba(53,122,189,0.3) 100%);"><div class="case-title">üë• TREINAR NOVATOS (COM GPS)</div><div class="case-desc">Check-in em dupla para treinar novos investigadores</div><div style="margin-top:10px;color:#ffd700;">üìç Requer localiza√ß√£o | üí∞ +$200 | üéì +1 Estrela Professor | üèÖ +15 rep | üîã -6</div></div><div class="case-card" onclick="startReportWriting()" style="cursor:pointer;"><div class="case-title">üìù ELABORAR RELAT√ìRIOS</div><div class="case-desc">Escreva relat√≥rios detalhados do dia de trabalho e envie para v√≠timas/superiores</div><div style="margin-top:10px;color:#ffd700;">üí∞ +$400 | ‚≠ê +50 | üèÖ +10 rep | üîã -7</div></div></div><div class="choices-container" style="margin-top:20px;"><button class="choice-btn" onclick="openWorkShift()">‚¨ÖÔ∏è VOLTAR</button></div></div>`;}

function showDocumentLocations() {
  const locations = getDocumentLocations();
  const canvas = document.getElementById('game-canvas');
  
  let locationsHTML = locations.map(loc => `
    <div class="case-card" onclick='collectDocuments(${JSON.stringify(loc)})' style="cursor:pointer;">
      <div class="case-title">${loc.icon} ${loc.name}</div>
      <div class="case-desc" style="font-size: 12px; color: #ccc; margin-bottom: 10px;">
        üìç ${loc.address}
      </div>
      <div style="margin-top:10px;display:flex;justify-content:space-between;font-size:13px;">
        <span style="color:#ffd700;">üí∞ $${loc.reward}</span>
        <span style="color:#51cf66;">‚≠ê +${loc.exp}</span>
        <span style="color:#4a90e2;">üèÖ +${loc.rep}</span>
        <span style="color:#e94560;">üîã -${loc.energy}</span>
      </div>
    </div>
  `).join('');
  
  canvas.innerHTML = `
    <div class="story-panel">
      <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">üìÑ</div>
      <div class="story-title">üìÑ LOCAIS DE COLETA</div>
      <div class="story-text">
        <p>Escolha onde deseja coletar documentos e provas!</p>
        <p style="color: #51cf66; font-size: 13px; margin-top: 10px;">‚ö†Ô∏è Voc√™ precisa estar a menos de 500m do local para coletar</p>
      </div>
      
      <div style="display: grid; gap: 15px; margin-top: 20px; max-height: 500px; overflow-y: auto;">
        ${locationsHTML}
      </div>

      <div class="choices-container" style="margin-top: 20px;">
        <button class="choice-btn" onclick="showAdminWork()">‚¨ÖÔ∏è VOLTAR</button>
      </div>
    </div>
  `;
}

function getDocumentLocations() {
  return [
    // BIBLIOTECAS
    {
      id: 'biblioteca-central',
      name: 'Biblioteca P√∫blica do Estado',
      icon: 'üìö',
      type: 'biblioteca',
      address: 'Rua Tenente Silveira, 343, Centro',
      lat: -27.5950,
      lng: -48.5510,
      reward: 350,
      exp: 60,
      rep: 10,
      energy: 5
    },
    {
      id: 'biblioteca-ufsc',
      name: 'Biblioteca Central UFSC',
      icon: 'üìö',
      type: 'biblioteca',
      address: 'Campus UFSC, Trindade',
      lat: -27.6006,
      lng: -48.5197,
      reward: 400,
      exp: 70,
      rep: 12,
      energy: 6
    },
    {
      id: 'biblioteca-lagoa',
      name: 'Biblioteca Comunit√°ria da Lagoa',
      icon: 'üìö',
      type: 'biblioteca',
      address: 'Lagoa da Concei√ß√£o',
      lat: -27.5980,
      lng: -48.4530,
      reward: 320,
      exp: 55,
      rep: 8,
      energy: 5
    },
    {
      id: 'biblioteca-ingleses',
      name: 'Biblioteca de Ingleses',
      icon: 'üìö',
      type: 'biblioteca',
      address: 'Ingleses do Rio Vermelho',
      lat: -27.4390,
      lng: -48.3917,
      reward: 300,
      exp: 50,
      rep: 8,
      energy: 4
    },
    {
      id: 'biblioteca-canasvieiras',
      name: 'Biblioteca de Canasvieiras',
      icon: 'üìö',
      type: 'biblioteca',
      address: 'Canasvieiras',
      lat: -27.4195,
      lng: -48.4578,
      reward: 310,
      exp: 52,
      rep: 9,
      energy: 4
    },
    
    // SUPERMERCADOS
    {
      id: 'angeloni-beiramar',
      name: 'Angeloni Beiramar',
      icon: 'üõí',
      type: 'supermercado',
      address: 'Shopping Beiramar, Centro',
      lat: -27.5940,
      lng: -48.5519,
      reward: 280,
      exp: 45,
      rep: 7,
      energy: 4
    },
    {
      id: 'big-trindade',
      name: 'Big Trindade',
      icon: 'üõí',
      type: 'supermercado',
      address: 'Trindade',
      lat: -27.5989,
      lng: -48.5223,
      reward: 290,
      exp: 48,
      rep: 7,
      energy: 4
    },
    {
      id: 'angeloni-lagoa',
      name: 'Angeloni Lagoa',
      icon: 'üõí',
      type: 'supermercado',
      address: 'Av. das Rendeiras, Lagoa',
      lat: -27.5975,
      lng: -48.4525,
      reward: 270,
      exp: 43,
      rep: 6,
      energy: 3
    },
    {
      id: 'bistek-ingleses',
      name: 'Bistek Supermercados',
      icon: 'üõí',
      type: 'supermercado',
      address: 'Ingleses',
      lat: -27.4410,
      lng: -48.3930,
      reward: 260,
      exp: 40,
      rep: 6,
      energy: 3
    },
    {
      id: 'angeloni-coqueiros',
      name: 'Angeloni Coqueiros',
      icon: 'üõí',
      type: 'supermercado',
      address: 'Coqueiros',
      lat: -27.5935,
      lng: -48.5650,
      reward: 275,
      exp: 44,
      rep: 7,
      energy: 4
    },
    {
      id: 'imperatriz-centro',
      name: 'Imperatriz Centro',
      icon: 'üõí',
      type: 'supermercado',
      address: 'Centro',
      lat: -27.5960,
      lng: -48.5490,
      reward: 285,
      exp: 46,
      rep: 7,
      energy: 4
    },
    {
      id: 'angeloni-rio-tavares',
      name: 'Angeloni Rio Tavares',
      icon: 'üõí',
      type: 'supermercado',
      address: 'Rio Tavares',
      lat: -27.6392,
      lng: -48.4820,
      reward: 265,
      exp: 42,
      rep: 6,
      energy: 3
    },
    {
      id: 'angeloni-canasvieiras',
      name: 'Angeloni Canasvieiras',
      icon: 'üõí',
      type: 'supermercado',
      address: 'Canasvieiras',
      lat: -27.4200,
      lng: -48.4590,
      reward: 270,
      exp: 43,
      rep: 6,
      energy: 3
    }
  ];
}

function collectDocuments(location) {
  if (currentPlayer.energy < location.energy) {
    showMessage('‚ùå Energia insuficiente!', 'error');
    return;
  }

  if (!navigator.geolocation) {
    showMessage('‚ùå Seu navegador n√£o suporta geolocaliza√ß√£o!', 'error');
    return;
  }

  showMessage('üìç Verificando sua localiza√ß√£o...', 'info');

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;
      const distance = calculateDistance(userLat, userLng, location.lat, location.lng);
      const maxDistance = 500;

      if (distance > maxDistance) {
        const distanceKm = (distance / 1000).toFixed(2);
        showMessage(`‚ùå Muito longe! Dist√¢ncia: ${distanceKm}km. Precisa estar a menos de 500m.`, 'error');
        return;
      }

      currentPlayer.money += location.reward;
      currentPlayer.exp += location.exp;
      currentPlayer.reputation += location.rep;
      currentPlayer.energy -= location.energy;
      currentPlayer.evidenceCollected = (currentPlayer.evidenceCollected || 0) + 1;
      
      savePlayerData();
      updateUI();

      showMessage(`‚úÖ Documentos coletados! +$${location.reward} | +${location.exp} EXP`, 'success');

      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align:center;font-size:80px;margin-bottom:20px;">üìÑ</div>
          <div class="story-title">‚úÖ DOCUMENTOS COLETADOS!</div>
          <div class="story-text">
            <p>Voc√™ chegou ao local e coletou os documentos com sucesso!</p>
            <p style="color: #ffd700; font-size: 18px; margin-top: 10px;"><strong>${location.icon} ${location.name}</strong></p>
            <p style="color: #ccc; font-size: 14px; margin-top: 5px;">üìç ${location.address}</p>
          </div>

          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(81,207,102,0.3) 0%, rgba(55,178,77,0.3) 100%); border-color: #51cf66;">
            <div class="mystery-label" style="color: #51cf66;">üí∞ RECOMPENSAS RECEBIDAS</div>
            <div style="color: #fff; font-size: 18px; margin-top: 15px;">
              <p>üíµ Dinheiro: <strong style="color: #ffd700;">+$${location.reward}</strong></p>
              <p>‚≠ê Experi√™ncia: <strong style="color: #51cf66;">+${location.exp} EXP</strong></p>
              <p>üèÖ Reputa√ß√£o: <strong style="color: #4a90e2;">+${location.rep}</strong></p>
              <p>üîç Evid√™ncias: <strong style="color: #fff;">+1</strong></p>
            </div>
          </div>

          <div class="choices-container" style="margin-top:25px;">
            <button class="choice-btn" onclick="showDocumentLocations()" style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); color: #000;">
              üìÑ PR√ìXIMO LOCAL
            </button>
            <button class="choice-btn" onclick="showAdminWork()">
              ‚¨ÖÔ∏è VOLTAR AO MENU
            </button>
          </div>
        </div>
      `;
    },
    (error) => {
      let errorMsg = '‚ùå N√£o foi poss√≠vel obter sua localiza√ß√£o. ';
      if (error.code === error.PERMISSION_DENIED) {
        errorMsg += 'Permita o acesso √† localiza√ß√£o.';
      } else if (error.code === error.POSITION_UNAVAILABLE) {
        errorMsg += 'Localiza√ß√£o indispon√≠vel.';
      } else if (error.code === error.TIMEOUT) {
        errorMsg += 'Tempo esgotado. Tente novamente.';
      }
      showMessage(errorMsg, 'error');
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

function showTrainingLocations() {
  const locations = getTrainingLocations();
  const canvas = document.getElementById('game-canvas');
  
  let locationsHTML = locations.map(loc => `
    <div class="case-card" onclick='startTraining(${JSON.stringify(loc)})' style="cursor:pointer;">
      <div class="case-title">${loc.name}</div>
      <div class="case-desc" style="font-size: 12px; color: #ccc; margin-bottom: 10px;">
        üìç ${loc.address}
      </div>
      <div style="margin-top:10px;color:#ffd700;">
        üí∞ +$200 | üéì +1 Estrela Professor | üèÖ +15 Rep | üîã -6
      </div>
    </div>
  `).join('');
  
  canvas.innerHTML = `
    <div class="story-panel">
      <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">üë•</div>
      <div class="story-title">üë• TREINAR NOVATOS</div>
      <div class="story-text">
        <p>Escolha um local para treinar investigadores iniciantes!</p>
        <p style="color: #ffd700;">üéì Voc√™ ganha <strong>Estrelas de Professor</strong> por cada treinamento!</p>
        <p style="color: #51cf66; font-size: 13px; margin-top: 10px;">‚ö†Ô∏è Voc√™ e outro jogador precisam estar a menos de 500m do local</p>
        <p style="color: #4a90e2; font-size: 13px;">üë• Check-in em dupla: Professor + Novato</p>
      </div>
      
      <div style="display: grid; gap: 15px; margin-top: 20px; max-height: 500px; overflow-y: auto;">
        ${locationsHTML}
      </div>

      <div class="choices-container" style="margin-top: 20px;">
        <button class="choice-btn" onclick="showAdminWork()">‚¨ÖÔ∏è VOLTAR</button>
      </div>
    </div>
  `;
}

function getTrainingLocations() {
  return [
    {
      id: 'academia-policia',
      name: 'üéì Academia de Pol√≠cia Central',
      address: 'Centro de Florian√≥polis',
      lat: -27.5950,
      lng: -48.5490
    },
    {
      id: 'campo-treinamento-norte',
      name: 'üèãÔ∏è Campo de Treinamento Norte',
      address: 'Canasvieiras',
      lat: -27.4200,
      lng: -48.4580
    },
    {
      id: 'centro-formacao-lagoa',
      name: 'üìö Centro de Forma√ß√£o da Lagoa',
      address: 'Lagoa da Concei√ß√£o',
      lat: -27.5980,
      lng: -48.4530
    },
    {
      id: 'delegacia-trindade',
      name: 'üöî Delegacia Escola Trindade',
      address: 'Trindade - pr√≥ximo √† UFSC',
      lat: -27.6000,
      lng: -48.5200
    }
  ];
}

function startTraining(location) {
  if (currentPlayer.energy < 6) {
    showMessage('‚ùå Energia insuficiente! (precisa de 6)', 'error');
    return;
  }

  if (!navigator.geolocation) {
    showMessage('‚ùå Seu navegador n√£o suporta geolocaliza√ß√£o!', 'error');
    return;
  }

  showMessage('üìç Verificando sua localiza√ß√£o...', 'info');

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;
      const distance = calculateDistance(userLat, userLng, location.lat, location.lng);
      const maxDistance = 500;

      if (distance > maxDistance) {
        const distanceKm = (distance / 1000).toFixed(2);
        showMessage(`‚ùå Muito longe! Dist√¢ncia: ${distanceKm}km. Precisa estar a menos de 500m.`, 'error');
        return;
      }

      currentPlayer.money += 200;
      currentPlayer.reputation += 15;
      currentPlayer.energy -= 6;
      currentPlayer.professorStars = (currentPlayer.professorStars || 0) + 1;
      
      savePlayerData();
      updateUI();

      showMessage(`‚úÖ Treinamento conclu√≠do! +$200 | üéì +1 Estrela`, 'success');

      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align:center;font-size:80px;margin-bottom:20px;">üéì</div>
          <div class="story-title">‚úÖ TREINAMENTO CONCLU√çDO!</div>
          <div class="story-text">
            <p>Voc√™ treinou novatos com sucesso e ganhou uma estrela de professor!</p>
            <p style="color: #ffd700; font-size: 18px; margin-top: 10px;"><strong>${location.name}</strong></p>
            <p style="color: #ccc; font-size: 14px; margin-top: 5px;">üìç ${location.address}</p>
          </div>

          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(81,207,102,0.3) 0%, rgba(55,178,77,0.3) 100%); border-color: #51cf66;">
            <div class="mystery-label" style="color: #51cf66;">üí∞ RECOMPENSAS RECEBIDAS</div>
            <div style="color: #fff; font-size: 18px; margin-top: 15px;">
              <p>üíµ Dinheiro: <strong style="color: #ffd700;">+$200</strong></p>
              <p>üéì Estrelas de Professor: <strong style="color: #4a90e2;">+1 (Total: ${currentPlayer.professorStars})</strong></p>
              <p>üèÖ Reputa√ß√£o: <strong style="color: #51cf66;">+15</strong></p>
            </div>
          </div>

          <div style="background: rgba(74,144,226,0.3); border: 2px solid #4a90e2; border-radius: 10px; padding: 15px; margin-top: 15px;">
            <p style="color: #ffd700; font-weight: 700;">üéì VOC√ä POSSUI ${currentPlayer.professorStars} ESTRELA(S) DE PROFESSOR!</p>
            <p style="color: #fff; font-size: 14px; margin-top: 5px;">Continue treinando para acumular mais estrelas e se tornar um professor renomado!</p>
          </div>

          <div class="choices-container" style="margin-top:25px;">
            <button class="choice-btn" onclick="showTrainingLocations()" style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); color: #000;">
              üéì PR√ìXIMO TREINAMENTO
            </button>
            <button class="choice-btn" onclick="showAdminWork()">
              ‚¨ÖÔ∏è VOLTAR AO MENU
            </button>
          </div>
        </div>
      `;
    },
    (error) => {
      let errorMsg = '‚ùå N√£o foi poss√≠vel obter sua localiza√ß√£o. ';
      if (error.code === error.PERMISSION_DENIED) {
        errorMsg += 'Permita o acesso √† localiza√ß√£o.';
      } else if (error.code === error.POSITION_UNAVAILABLE) {
        errorMsg += 'Localiza√ß√£o indispon√≠vel.';
      } else if (error.code === error.TIMEOUT) {
        errorMsg += 'Tempo esgotado. Tente novamente.';
      }
      showMessage(errorMsg, 'error');
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

function doAdmin(m,e,ec,r){if(currentPlayer.energy<ec){showMessage('‚ùå Energia insuficiente!','error');return;}currentPlayer.money+=m;currentPlayer.exp+=e;currentPlayer.energy-=ec;currentPlayer.reputation+=r;savePlayerData();updateUI();showMessage(`‚úÖ Tarefa conclu√≠da! +$${m} | +${e} EXP`,'success');setTimeout(()=>showAdminWork(),1500);}

function showRestOptions(){const c=document.getElementById('game-canvas');c.innerHTML=`<div class="story-panel"><div style="text-align:center;font-size:60px;margin-bottom:15px;">üò¥</div><div class="story-title">üò¥ DESCANSO E RECUPERA√á√ÉO</div><div class="story-text"><p>Descanse para recuperar sua energia!</p><p style="color:#ffd700;">Energia atual: <strong>${currentPlayer.energy}/${currentPlayer.maxEnergy}</strong></p></div><div style="display:grid;gap:12px;margin-top:20px;"><div class="case-card" onclick="showQuickBreakLocations()" style="cursor:pointer;"><div class="case-title">‚òï INTERVALO RÔøΩÔøΩPIDO (COM GPS)</div><div class="case-desc">V√° at√© a praia ou shopping para descansar</div><div style="margin-top:10px;color:#51cf66;">üîã +20 energia | ‚è±Ô∏è 1 hora | üìç Praia ou Shopping</div></div><div class="case-card" onclick="showLunchLocations()" style="cursor:pointer;"><div class="case-title">üçΩÔ∏è ALMO√áO E DESCANSO (COM GPS)</div><div class="case-desc">Almoce em restaurantes ou pra√ßas</div><div style="margin-top:10px;color:#51cf66;">üîã +40 energia | ‚è±Ô∏è 2 horas | üìç Restaurantes/Pra√ßas</div></div><div class="case-card" onclick="showNapLocations()" style="cursor:pointer;"><div class="case-title">üõãÔ∏è COCHILO PROLONGADO (COM GPS)</div><div class="case-desc">Tire uma soneca em um hotel</div><div style="margin-top:10px;color:#51cf66;">üîã +70 energia | ‚è±Ô∏è 4 horas | üìç Hot√©is (1-5 ‚≠ê)</div></div><div class="case-card" onclick="showSleepLocations()" style="cursor:pointer;background:linear-gradient(135deg,rgba(81,207,102,0.3) 0%,rgba(55,178,77,0.3) 100%);"><div class="case-title">üåô NOITE DE SONO COMPLETA (COM GPS)</div><div class="case-desc">Durma uma noite inteira em hotel - recupera√ß√£o total!</div><div style="margin-top:10px;color:#51cf66;">üîã +100 (FULL) | ‚è±Ô∏è 8 horas | üí∞ -$100 | üìç Hot√©is</div></div></div><div class="choices-container" style="margin-top:20px;"><button class="choice-btn" onclick="openWorkShift()">‚¨ÖÔ∏è VOLTAR</button></div></div>`;}

function showQuickBreakLocations() {
  const locations = [
    { id: 'praia-mole', name: 'üèñÔ∏è Praia Mole', address: 'Praia Mole', lat: -27.6089, lng: -48.4319 },
    { id: 'praia-joaquina', name: 'üèñÔ∏è Praia da Joaquina', address: 'Praia da Joaquina', lat: -27.6294, lng: -48.4453 },
    { id: 'praia-campeche', name: 'üèñÔ∏è Praia do Campeche', address: 'Campeche', lat: -27.6872, lng: -48.4836 },
    { id: 'praia-ingleses', name: 'üèñÔ∏è Praia de Ingleses', address: 'Ingleses', lat: -27.4400, lng: -48.3920 },
    { id: 'shopping-beiramar', name: 'üõçÔøΩÔøΩ Shopping Beiramar', address: 'Centro', lat: -27.5940, lng: -48.5519 },
    { id: 'shopping-iguatemi', name: 'üõçÔ∏è Shopping Iguatemi', address: 'Av. Gov. Irineu Bornhausen', lat: -27.5764, lng: -48.5647 }
  ];
  showRestLocationList(locations, '‚òï INTERVALO R√ÅPIDO', 20, 0, '‚òï');
}

function showLunchLocations() {
  const locations = [
    { id: 'praca-xv', name: 'üèõÔ∏è Pra√ßa XV de Novembro', address: 'Centro', lat: -27.5969, lng: -48.5480 },
    { id: 'praca-beira-mar', name: 'üåä Pra√ßa Beira-Mar', address: 'Beira-Mar Norte', lat: -27.5920, lng: -48.5520 },
    { id: 'rest-box32', name: 'üçΩÔ∏è Box 32 (Mercado P√∫blico)', address: 'Mercado P√∫blico, Centro', lat: -27.5949, lng: -48.5502 },
    { id: 'rest-ostradamus', name: 'ü¶™ Ostradamus', address: 'Rod. Admar Gonzaga, Itacorubi', lat: -27.5889, lng: -48.5147 },
    { id: 'rest-toca', name: 'üç¥ Toca da Garoupa', address: 'Lagoa da Concei√ß√£o', lat: -27.5969, lng: -48.4519 },
    { id: 'rest-vila-taipa', name: 'üç§ Vila Taipa', address: 'Lagoa da Concei√ß√£o', lat: -27.6000, lng: -48.4550 }
  ];
  showRestLocationList(locations, 'üçΩÔ∏è ALMO√áO E DESCANSO', 40, 0, 'üçΩÔ∏è');
}

function showNapLocations() {
  const locations = [
    { id: 'hotel-faial', name: '‚≠ê Hotel Faial (1‚òÖ)', address: 'Centro', lat: -27.5950, lng: -48.5490, stars: 1 },
    { id: 'hotel-veleiros', name: '‚≠ê‚≠ê Hotel dos Veleiros (2‚òÖ)', address: 'Lagoa', lat: -27.5980, lng: -48.4530, stars: 2 },
    { id: 'hotel-intercity', name: '‚≠ê‚≠ê‚≠ê Intercity Portofino (3‚òÖ)', address: 'Av. Paulo Fontes', lat: -27.5833, lng: -48.5611, stars: 3 },
    { id: 'hotel-jurer√™', name: '‚≠ê‚≠ê‚≠ê‚≠ê Il Campanario (4‚òÖ)', address: 'Jurer√™ Internacional', lat: -27.4428, lng: -48.4944, stars: 4 },
    { id: 'hotel-costao', name: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Cost√£o do Santinho Resort (5‚òÖ)', address: 'Santinho', lat: -27.4342, lng: -48.3936, stars: 5 }
  ];
  showRestLocationList(locations, 'üõãÔ∏è COCHILO PROLONGADO', 70, 0, 'üõãÔ∏è');
}

function showSleepLocations() {
  const locations = [
    { id: 'hotel-faial-sleep', name: '‚≠ê Hotel Faial (1‚òÖ)', address: 'Centro', lat: -27.5950, lng: -48.5490, stars: 1 },
    { id: 'hotel-veleiros-sleep', name: '‚≠ê‚≠ê Hotel dos Veleiros (2‚òÖ)', address: 'Lagoa', lat: -27.5980, lng: -48.4530, stars: 2 },
    { id: 'hotel-intercity-sleep', name: '‚≠ê‚≠ê‚≠ê Intercity Portofino (3‚òÖ)', address: 'Av. Paulo Fontes', lat: -27.5833, lng: -48.5611, stars: 3 },
    { id: 'hotel-jurer√™-sleep', name: '‚≠ê‚≠ê‚≠ê‚≠ê Il Campanario (4‚òÖ)', address: 'Jurer√™ Internacional', lat: -27.4428, lng: -48.4944, stars: 4 },
    { id: 'hotel-costao-sleep', name: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Cost√£o do Santinho Resort (5‚òÖ)', address: 'Santinho', lat: -27.4342, lng: -48.3936, stars: 5 }
  ];
  showRestLocationList(locations, 'üåô NOITE DE SONO COMPLETA', 100, 100, 'üåô');
}

function showRestLocationList(locations, title, energy, cost, icon) {
  const canvas = document.getElementById('game-canvas');
  
  let locationsHTML = locations.map(loc => {
    const costText = cost > 0 ? `| üí∞ -$${cost}` : '';
    return `
      <div class="case-card" onclick='doRestWithGPS(${JSON.stringify(loc)}, ${energy}, ${cost}, "${icon}")' style="cursor:pointer;">
        <div class="case-title">${loc.name}</div>
        <div class="case-desc" style="font-size: 12px; color: #ccc; margin-bottom: 10px;">
          üìç ${loc.address}
        </div>
        <div style="margin-top:10px;color:#51cf66;font-weight:700;">
          üîã +${energy} energia ${costText}
        </div>
      </div>
    `;
  }).join('');
  
  canvas.innerHTML = `
    <div class="story-panel">
      <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">${icon}</div>
      <div class="story-title">${title}</div>
      <div class="story-text">
        <p>Escolha um local para descansar e recuperar energia!</p>
        <p style="color: #51cf66; font-size: 13px; margin-top: 10px;">‚ö†Ô∏è Voc√™ precisa estar a menos de 500m do local para fazer check-in</p>
        ${cost > 0 ? `<p style="color: #ffd700; font-size: 13px; margin-top: 5px;">üí∞ Custo: $${cost}</p>` : ''}
      </div>
      
      <div style="display: grid; gap: 15px; margin-top: 20px; max-height: 500px; overflow-y: auto;">
        ${locationsHTML}
      </div>

      <div class="choices-container" style="margin-top: 20px;">
        <button class="choice-btn" onclick="showRestOptions()">‚¨ÖÔ∏è VOLTAR</button>
      </div>
    </div>
  `;
}

function doRestWithGPS(location, energy, cost, icon) {
  if (cost > 0 && currentPlayer.money < cost) {
    showMessage(`‚ùå Dinheiro insuficiente! Voc√™ precisa de $${cost}.`, 'error');
    return;
  }

  if (!navigator.geolocation) {
    showMessage('‚ùå Seu navegador n√£o suporta geolocaliza√ß√£o!', 'error');
    return;
  }

  showMessage('üìç Verificando sua localiza√ß√£o...', 'info');

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;
      const distance = calculateDistance(userLat, userLng, location.lat, location.lng);
      const maxDistance = 500;

      if (distance > maxDistance) {
        const distanceKm = (distance / 1000).toFixed(2);
        showMessage(`‚ùå Muito longe! Dist√¢ncia: ${distanceKm}km. Precisa estar a menos de 500m.`, 'error');
        return;
      }

      currentPlayer.energy = Math.min(currentPlayer.maxEnergy, currentPlayer.energy + energy);
      if (cost > 0) {
        currentPlayer.money -= cost;
      }
      
      savePlayerData();
      updateUI();

      const costText = cost > 0 ? ` | Pagou $${cost}` : '';
      showMessage(`${icon} Check-in realizado! +${energy} energia${costText}`, 'success');

      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align:center;font-size:80px;margin-bottom:20px;">${icon}</div>
          <div class="story-title">‚úÖ DESCANSO COMPLETADO!</div>
          <div class="story-text">
            <p>Voc√™ descansou e recuperou energia!</p>
            <p style="color: #ffd700; font-size: 18px; margin-top: 10px;"><strong>${location.name}</strong></p>
            <p style="color: #ccc; font-size: 14px; margin-top: 5px;">üìç ${location.address}</p>
          </div>

          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(81,207,102,0.3) 0%, rgba(55,178,77,0.3) 100%); border-color: #51cf66;">
            <div class="mystery-label" style="color: #51cf66;">üíö BENEF√çCIOS</div>
            <div style="color: #fff; font-size: 18px; margin-top: 15px;">
              <p>üîã Energia recuperada: <strong style="color: #51cf66;">+${energy}</strong></p>
              ${cost > 0 ? `<p>üíµ Custo: <strong style="color: #e94560;">-$${cost}</strong></p>` : '<p style="color: #51cf66;">üíµ Gratuito!</p>'}
              <p style="margin-top: 10px;">Energia atual: <strong style="color: #ffd700;">${currentPlayer.energy}/${currentPlayer.maxEnergy}</strong></p>
            </div>
          </div>

          <div class="choices-container" style="margin-top:25px;">
            <button class="choice-btn" onclick="showRestOptions()" style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); color: #000;">
              ${icon} DESCANSAR NOVAMENTE
            </button>
            <button class="choice-btn" onclick="openWorkShift()">
              ‚¨ÖÔ∏è VOLTAR AO MENU
            </button>
          </div>
        </div>
      `;
    },
    (error) => {
      let errorMsg = '‚ùå N√£o foi poss√≠vel obter sua localiza√ß√£o. ';
      if (error.code === error.PERMISSION_DENIED) {
        errorMsg += 'Permita o acesso √† localiza√ß√£o.';
      } else if (error.code === error.POSITION_UNAVAILABLE) {
        errorMsg += 'Localiza√ß√£o indispon√≠vel.';
      } else if (error.code === error.TIMEOUT) {
        errorMsg += 'Tempo esgotado. Tente novamente.';
      }
      showMessage(errorMsg, 'error');
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

    function startReportWriting() {
      if (currentPlayer.energy < 7) {
        showMessage('‚ùå Energia insuficiente! (precisa de 7)', 'error');
        return;
      }

      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">üìù</div>
          <div class="story-title">üìù ELABORAR RELAT√ìRIO DO DIA</div>
          <div class="story-text">
            <p>Descreva detalhadamente o que voc√™ fez hoje e as provas/evid√™ncias coletadas.</p>
            <p style="color: #ffd700; margin-top: 10px;">Seu relat√≥rio ser√° enviado para v√≠timas e superiores.</p>
            <p style="color: #4a90e2; font-size: 13px; margin-top: 10px;">üí° Quanto mais detalhado, melhor a avalia√ß√£o!</p>
          </div>

          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(74,144,226,0.3) 0%, rgba(53,122,189,0.3) 100%);">
            <div class="mystery-label">üìã SEU RELAT√ìRIO</div>
            
            <div class="form-group" style="margin-top: 15px;">
              <label for="report-victim" style="color: #ffd700; font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">
                üë§ Para quem voc√™ est√° enviando este relat√≥rio?
              </label>
              <input 
                type="text" 
                id="report-victim" 
                placeholder="Ex: Maria Silva (v√≠tima), Delegado Jo√£o (superior)"
                style="width: 100%; padding: 12px; border: 2px solid #ffd700; border-radius: 8px; background: rgba(0,0,0,0.6); color: #fff; font-size: 14px; font-family: 'Raleway', sans-serif;"
              >
            </div>

            <div class="form-group" style="margin-top: 15px;">
              <label for="report-summary" style="color: #ffd700; font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">
                üìÑ Resumo das Atividades do Dia
              </label>
              <textarea 
                id="report-summary" 
                rows="3" 
                placeholder="Descreva o que voc√™ fez durante o turno de trabalho..."
                style="width: 100%; padding: 12px; border: 2px solid #ffd700; border-radius: 8px; background: rgba(0,0,0,0.6); color: #fff; font-size: 14px; font-family: 'Raleway', sans-serif; resize: vertical;"
              ></textarea>
            </div>

            <div class="form-group" style="margin-top: 15px;">
              <label for="report-evidence" style="color: #ffd700; font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">
                üîç Provas e Evid√™ncias Coletadas
              </label>
              <textarea 
                id="report-evidence" 
                rows="4" 
                placeholder="Liste todas as provas, documentos e evid√™ncias que voc√™ coletou..."
                style="width: 100%; padding: 12px; border: 2px solid #ffd700; border-radius: 8px; background: rgba(0,0,0,0.6); color: #fff; font-size: 14px; font-family: 'Raleway', sans-serif; resize: vertical;"
              ></textarea>
            </div>

            <div class="form-group" style="margin-top: 15px;">
              <label for="report-conclusions" style="color: #ffd700; font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">
                üí° Conclus√µes e Pr√≥ximos Passos
              </label>
              <textarea 
                id="report-conclusions" 
                rows="3" 
                placeholder="Suas conclus√µes e recomenda√ß√µes para continuar a investiga√ß√£o..."
                style="width: 100%; padding: 12px; border: 2px solid #ffd700; border-radius: 8px; background: rgba(0,0,0,0.6); color: #fff; font-size: 14px; font-family: 'Raleway', sans-serif; resize: vertical;"
              ></textarea>
            </div>
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            <button class="choice-btn" onclick="submitReport()" style="background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: #fff;">
              ‚úÖ ENVIAR RELAT√ìRIO
            </button>
            <button class="choice-btn" onclick="showAdminWork()">
              ‚ùå CANCELAR
            </button>
          </div>
        </div>
      `;
    }

    function submitReport() {
      const victim = document.getElementById('report-victim').value.trim();
      const summary = document.getElementById('report-summary').value.trim();
      const evidence = document.getElementById('report-evidence').value.trim();
      const conclusions = document.getElementById('report-conclusions').value.trim();

      if (!victim) {
        showMessage('‚ùå Digite o nome do destinat√°rio do relat√≥rio!', 'error');
        return;
      }

      if (!summary) {
        showMessage('‚ùå Escreva um resumo das suas atividades!', 'error');
        return;
      }

      if (!evidence) {
        showMessage('‚ùå Liste as provas e evid√™ncias coletadas!', 'error');
        return;
      }

      if (!conclusions) {
        showMessage('‚ùå Escreva suas conclus√µes!', 'error');
        return;
      }

      const wordCount = (summary + ' ' + evidence + ' ' + conclusions).split(/\s+/).length;
      let bonus = 0;
      let quality = '';

      if (wordCount >= 100) {
        bonus = 200;
        quality = 'EXCELENTE';
      } else if (wordCount >= 50) {
        bonus = 100;
        quality = 'BOM';
      } else if (wordCount >= 20) {
        bonus = 50;
        quality = 'SATISFAT√ìRIO';
      } else {
        quality = 'B√ÅSICO';
      }

      currentPlayer.money += 400 + bonus;
      currentPlayer.exp += 50 + (bonus / 4);
      currentPlayer.reputation += 10 + (bonus / 20);
      currentPlayer.energy -= 7;

      const report = {
        id: Date.now().toString(),
        victim: victim,
        summary: summary,
        evidence: evidence,
        conclusions: conclusions,
        quality: quality,
        wordCount: wordCount,
        reward: 400 + bonus,
        submittedAt: new Date().toISOString()
      };

      if (!currentPlayer.reports) {
        currentPlayer.reports = [];
      }
      currentPlayer.reports.push(report);

      savePlayerData();
      updateUI();

      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 80px; margin-bottom: 20px;">üì¨</div>
          <div class="story-title">‚úÖ RELAT√ìRIO ENVIADO!</div>
          <div class="story-text">
            <p>Seu relat√≥rio foi enviado com sucesso para:</p>
            <p style="color: #ffd700; font-size: 18px; margin-top: 10px;"><strong>üë§ ${victim}</strong></p>
          </div>

          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(74,144,226,0.3) 0%, rgba(53,122,189,0.3) 100%);">
            <div class="mystery-label">üìä AVALIA√á√ÉO DO RELAT√ìRIO</div>
            <div style="margin-top: 15px;">
              <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                <div style="font-size: 13px; color: #ffd700; margin-bottom: 5px;">QUALIDADE</div>
                <div style="font-size: 24px; font-weight: 900; color: #fff;">${quality}</div>
              </div>
              <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 10px;">
                <div style="font-size: 13px; color: #ccc;">üìù Palavras escritas: <strong style="color: #fff;">${wordCount}</strong></div>
                ${bonus > 0 ? `<div style="font-size: 13px; color: #51cf66; margin-top: 5px;">üí∞ B√¥nus por qualidade: <strong>+$${bonus}</strong></div>` : ''}
              </div>
            </div>
          </div>

          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(81,207,102,0.3) 0%, rgba(55,178,77,0.3) 100%); border-color: #51cf66; margin-top: 15px;">
            <div class="mystery-label" style="color: #51cf66;">üí∞ RECOMPENSAS RECEBIDAS</div>
            <div style="color: #fff; font-size: 18px; margin-top: 15px;">
              <p>üíµ Dinheiro: <strong style="color: #ffd700;">+$${400 + bonus}</strong></p>
              <p>‚≠ê Experi√™ncia: <strong style="color: #51cf66;">+${50 + (bonus / 4)} EXP</strong></p>
              <p>üèÖ Reputa√ß√£o: <strong style="color: #4a90e2;">+${10 + (bonus / 20)}</strong></p>
            </div>
          </div>

          <div style="background: rgba(74,144,226,0.2); border: 2px solid #4a90e2; border-radius: 10px; padding: 15px; margin-top: 15px;">
            <div style="font-size: 14px; color: #4a90e2; font-weight: 700; margin-bottom: 8px;">üìã RESUMO DO SEU RELAT√ìRIO</div>
            <div style="font-size: 13px; color: #fff; line-height: 1.6;">
              <p><strong style="color: #ffd700;">Atividades:</strong> ${summary.substring(0, 100)}${summary.length > 100 ? '...' : ''}</p>
              <p style="margin-top: 8px;"><strong style="color: #ffd700;">Evid√™ncias:</strong> ${evidence.substring(0, 100)}${evidence.length > 100 ? '...' : ''}</p>
              <p style="margin-top: 8px;"><strong style="color: #ffd700;">Conclus√µes:</strong> ${conclusions.substring(0, 100)}${conclusions.length > 100 ? '...' : ''}</p>
            </div>
          </div>

          <div style="background: rgba(255,215,0,0.2); border: 2px solid #ffd700; border-radius: 10px; padding: 12px; margin-top: 15px;">
            <p style="color: #ffd700; font-weight: 700; font-size: 13px;">üí° DICA PARA RELAT√ìRIOS MELHORES:</p>
            <p style="color: #fff; font-size: 12px; margin-top: 5px;">
              ‚Ä¢ <strong>20+ palavras:</strong> B√°sico | <strong>50+ palavras:</strong> B√¥nus +$50 +$100<br>
              ‚Ä¢ <strong>100+ palavras:</strong> B√¥nus +$200 (Excelente!)
            </p>
          </div>

          <div class="choices-container" style="margin-top: 25px;">
            <button class="choice-btn" onclick="viewReportHistory()" style="background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: #fff;">
              üìö VER HIST√ìRICO DE RELAT√ìRIOS
            </button>
            <button class="choice-btn" onclick="startReportWriting()" style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); color: #000;">
              üìù NOVO RELAT√ìRIO
            </button>
            <button class="choice-btn" onclick="showAdminWork()">
              ‚¨ÖÔ∏è VOLTAR AO MENU
            </button>
          </div>
        </div>
      `;
    }

    function viewReportHistory() {
      if (!currentPlayer.reports || currentPlayer.reports.length === 0) {
        showMessage('üìã Voc√™ ainda n√£o enviou nenhum relat√≥rio!', 'info');
        setTimeout(() => showAdminWork(), 1500);
        return;
      }

      const reports = currentPlayer.reports.slice().reverse();

      const reportsHTML = reports.map((report, index) => {
        const date = new Date(report.submittedAt);
        const dateStr = date.toLocaleDateString('pt-BR');
        const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

        let qualityColor = '#ccc';
        if (report.quality === 'EXCELENTE') qualityColor = '#51cf66';
        else if (report.quality === 'BOM') qualityColor = '#4a90e2';
        else if (report.quality === 'SATISFAT√ìRIO') qualityColor = '#ffd700';

        return `
          <div class="case-card" onclick='viewReportDetail(${JSON.stringify(report).replace(/'/g, "\\'")})'  style="cursor: pointer;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <div>
                <div class="case-title" style="font-size: 16px;">üìù Relat√≥rio #${reports.length - index}</div>
                <div style="font-size: 12px; color: #ccc; margin-top: 3px;">üë§ ${report.victim}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 11px; color: #ccc;">${dateStr}</div>
                <div style="font-size: 11px; color: #ccc;">${timeStr}</div>
              </div>
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-top: 10px;">
              <div style="font-size: 12px; color: ${qualityColor}; font-weight: 700; margin-bottom: 5px;">
                QUALIDADE: ${report.quality}
              </div>
              <div style="font-size: 11px; color: #ccc;">
                üìù ${report.wordCount} palavras | üí∞ $${report.reward}
              </div>
            </div>
          </div>
        `;
      }).join('');

      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">üìö</div>
          <div class="story-title">üìö HIST√ìRICO DE RELAT√ìRIOS</div>
          <div class="story-text">
            <p>Total de relat√≥rios enviados: <strong style="color: #ffd700;">${reports.length}</strong></p>
            <p style="color: #4a90e2; font-size: 13px; margin-top: 5px;">Clique em um relat√≥rio para ver os detalhes completos</p>
          </div>

          <div style="display: grid; gap: 12px; margin-top: 20px; max-height: 500px; overflow-y: auto;">
            ${reportsHTML}
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            <button class="choice-btn" onclick="showAdminWork()">‚¨ÖÔ∏è VOLTAR</button>
          </div>
        </div>
      `;
    }

    function viewReportDetail(report) {
      const date = new Date(report.submittedAt);
      const dateStr = date.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      const timeStr = date.toLocaleTimeString('pt-BR');

      let qualityColor = '#ccc';
      let qualityIcon = 'üìã';
      if (report.quality === 'EXCELENTE') {
        qualityColor = '#51cf66';
        qualityIcon = 'üåü';
      } else if (report.quality === 'BOM') {
        qualityColor = '#4a90e2';
        qualityIcon = '‚ú®';
      } else if (report.quality === 'SATISFAT√ìRIO') {
        qualityColor = '#ffd700';
        qualityIcon = '‚≠ê';
      }

      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">ÔøΩÔøΩ</div>
          <div class="story-title">üìÑ RELAT√ìRIO COMPLETO</div>
          
          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(74,144,226,0.3) 0%, rgba(53,122,189,0.3) 100%);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div>
                <div style="font-size: 14px; color: #ffd700; font-weight: 700;">üë§ DESTINAT√ÅRIO</div>
                <div style="font-size: 18px; color: #fff; margin-top: 3px;">${report.victim}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 12px; color: #ccc;">${dateStr}</div>
                <div style="font-size: 12px; color: #ccc; margin-top: 2px;">${timeStr}</div>
              </div>
            </div>

            <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 8px; margin-top: 15px;">
              <div style="font-size: 12px; color: ${qualityColor}; font-weight: 700; margin-bottom: 8px;">
                ${qualityIcon} AVALIA√á√ÉO: ${report.quality}
              </div>
              <div style="font-size: 12px; color: #ccc;">
                üìù ${report.wordCount} palavras | üí∞ Recompensa: $${report.reward}
              </div>
            </div>
          </div>

          <div class="mystery-box" style="margin-top: 15px;">
            <div class="mystery-label">üìÑ RESUMO DAS ATIVIDADES</div>
            <div style="color: #fff; font-size: 14px; line-height: 1.7; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
              ${report.summary}
            </div>
          </div>

          <div class="mystery-box" style="margin-top: 15px;">
            <div class="mystery-label">üîç PROVAS E EVID√äNCIAS</div>
            <div style="color: #fff; font-size: 14px; line-height: 1.7; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
              ${report.evidence}
            </div>
          </div>

          <div class="mystery-box" style="margin-top: 15px;">
            <div class="mystery-label">üí° CONCLUS√ïES E PR√ìXIMOS PASSOS</div>
            <div style="color: #fff; font-size: 14px; line-height: 1.7; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;">
              ${report.conclusions}
            </div>
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            <button class="choice-btn" onclick="viewReportHistory()">
              ‚¨ÖÔ∏è VOLTAR AO HIST√ìRICO
            </button>
          </div>
        </div>
      `;
    }

    function openRanking() {
      const allPlayers = JSON.parse(localStorage.getItem('players') || '[]');
      
      if (allPlayers.length === 0) {
        showMessage('‚ùå Nenhum investigador registrado ainda!', 'info');
        return;
      }

      const sortedPlayers = allPlayers.sort((a, b) => {
        if (b.casesSolved !== a.casesSolved) {
          return b.casesSolved - a.casesSolved;
        }
        return b.money - a.money;
      });

      const canvas = document.getElementById('game-canvas');
      
      let rankingHTML = sortedPlayers.map((player, index) => {
        const position = index + 1;
        let positionClass = 'other';
        let medal = '';
        let cardClass = '';

        if (position === 1) {
          positionClass = 'top1';
          cardClass = 'top1';
          medal = '<div class="ranking-medal">ü•á</div>';
        } else if (position === 2) {
          positionClass = 'top2';
          cardClass = 'top2';
          medal = '<div class="ranking-medal">ü•à</div>';
        } else if (position === 3) {
          positionClass = 'top3';
          cardClass = 'top3';
          medal = '<div class="ranking-medal">ü•â</div>';
        }

        const isCurrentPlayer = currentPlayer && player.id === currentPlayer.id;
        const highlightStyle = isCurrentPlayer ? 'box-shadow: 0 0 30px rgba(74,144,226,0.8); border-color: #4a90e2;' : '';

        const wealthStatus = getWealthStatus(player.money);
        const onlineTime = formatOnlineTime(player.totalOnlineTime || 0);

        return `
          <div class="ranking-card ${cardClass}" style="${highlightStyle}">
            <div class="ranking-position ${positionClass}">#${position}</div>
            ${medal}
            <div class="ranking-info">
              <div class="ranking-name">
                ${isCurrentPlayer ? 'üë§ ' : ''}${player.name}
                ${isCurrentPlayer ? ' (VOC√ä)' : ''}
              </div>
              <div class="ranking-stats">
                <span>üîç ${player.casesSolved} casos</span>
                <span>üí∞ $${player.money}</span>
                <span>‚≠ê ${player.exp} EXP</span>
                <span>üèÖ ${player.reputation} rep</span>
                <span>‚è±Ô∏è ${onlineTime}</span>
              </div>
              <div style="margin-top: 5px; font-size: 12px; color: ${wealthStatus.color};">
                ${wealthStatus.text}
              </div>
            </div>
          </div>
        `;
      }).join('');

      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">üèÜ</div>
          <div class="story-title">üèÜ RANKING DE INVESTIGADORES</div>
          <div class="story-text">
            <p>Os melhores detetives de Florian√≥polis!</p>
            <p style="color: #ffd700; margin-top: 10px;">Ranking baseado em: Casos Resolvidos e Dinheiro</p>
          </div>

          <div style="margin-top: 20px; max-height: 600px; overflow-y: auto; padding-right: 10px;">
            ${rankingHTML}
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            <button class="choice-btn" onclick="loadWelcomeStory()">üè† VOLTAR</button>
          </div>
        </div>
      `;
    }

    function openCaseFiles() {
      const allCases = getAllCases();
      const canvas = document.getElementById('game-canvas');
      
      let casesHTML = allCases.map(c => `
        <div class="case-card" onclick="startCase('${c.id}')">
          <div class="case-title">${c.title}</div>
          <span class="case-difficulty ${c.difficulty}">${
            c.difficulty === 'easy' ? 'F√°cil' : 
            c.difficulty === 'medium' ? 'M√©dio' : 
            c.difficulty === 'hard' ? 'DifÔøΩÔøΩcil' : 'Extremo'
          }</span>
          <div class="case-desc">${c.desc}</div>
          <div style="margin-top: 10px; color: #ffd700;">üí∞ $${c.reward} | ‚≠ê +${c.exp} EXP | üîç ${c.evidence} evid√™ncias</div>
        </div>
      `).join('');

      canvas.innerHTML = `
        <div class="story-panel">
          <div class="story-title">üìÅ ARQUIVOS DE CASOS (${allCases.length} DISPON√çVEIS)</div>
          <div class="story-text">
            <p>Escolha um caso para investigar. Casos mais dif√≠ceis recompensam melhor!</p>
            <p style="color: #51cf66;">‚úÖ F√°ceis: 30 | üü° M√©dios: 30 | üî¥ Dif√≠ceis: 25 | ‚ö´ Extremos: 15</p>
          </div>
          
          <div style="display: grid; gap: 15px; margin-top: 20px; max-height: 600px; overflow-y: auto; padding-right: 10px;">
            ${casesHTML}
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            <button class="choice-btn" onclick="loadWelcomeStory()">‚¨ÖÔ∏è VOLTAR</button>
          </div>
        </div>
      `;
    }

    function getAllCases() {
      return [
        { 
          id: 'caso01', 
          title: 'üè™ Roubo no Mercado P√∫blico', 
          desc: 'Uma loja foi roubada durante a madrugada. V√° at√© os locais e colete evid√™ncias!', 
          difficulty: 'easy', 
          reward: 800, 
          exp: 150, 
          evidences: [
            { 
              id: 'ev01', 
              location: 'mercado-publico', 
              hint: 'üîç O que costuma ter em um mercado tradicional? Pense em onde as pessoas compram alimentos frescos...', 
              clue: 'üßæ Voc√™ encontrou um recibo rasgado com hor√°rio: 03:47 AM',
              collected: false
            },
            { 
              id: 'ev02', 
              location: 'catedral', 
              hint: '‚õ™ O que tem em uma igreja? Pense em objetos religiosos e onde as pessoas rezam...', 
              clue: 'üïØÔ∏è Voc√™ encontrou uma vela com cera ainda fresca e pegadas na entrada',
              collected: false
            },
            { 
              id: 'ev03', 
              location: 'praca-xv', 
              hint: 'üèõÔ∏è O que tem em uma pra√ßa hist√≥rica? Pense em monumentos e onde pessoas descansam...', 
              clue: 'üëú Uma bolsa abandonada embaixo de um banco com ferramentas de arrombamento',
              collected: false
            }
          ]
        },
        { 
          id: 'caso02', 
          title: 'üö≤ Furto de Bicicleta na Lagoa', 
          desc: 'Bicicletas est√£o desaparecendo na orla. Investigue os locais!', 
          difficulty: 'easy', 
          reward: 700, 
          exp: 130,
          evidences: [
            { 
              id: 'ev04', 
              location: 'centrinho-lagoa', 
              hint: 'üé™ O que tem no centro da Lagoa? Pense em bares, restaurantes e onde turistas se re√∫nem...', 
              clue: 'üìπ C√¢mera de seguran√ßa de um bar mostra um homem de bon√© vermelho',
              collected: false
            },
            { 
              id: 'ev05', 
              location: 'barra-lagoa', 
              hint: 'üö§ O que tem na Barra? Pense em barcos, pescadores e onde o mar encontra a lagoa...', 
              clue: 'üîó Corrente de bicicleta cortada encontrada perto dos barcos',
              collected: false
            },
            { 
              id: 'ev06', 
              location: 'lagoa-orla', 
              hint: 'üåä O que tem na orla? Pense em ciclovias, quiosques e onde as pessoas caminham...', 
              clue: 'üëü Marcas de pneu de bicicleta e pegadas levam para uma van branca',
              collected: false
            }
          ]
        },
        { 
          id: 'caso03', 
          title: 'üíé Roubo de Joias no Centro', 
          desc: 'Joalheria assaltada. Colete evid√™ncias nos locais indicados!', 
          difficulty: 'medium', 
          reward: 1200, 
          exp: 200,
          evidences: [
            { 
              id: 'ev07', 
              location: 'catedral', 
              hint: '‚õ™ O que tem em uma igreja antiga? Pense em confession√°rios e onde segredos s√£o guardados...', 
              clue: 'üíç Um anel de ouro esquecido no confession√°rio',
              collected: false
            },
            { 
              id: 'ev08', 
              location: 'mercado-publico', 
              hint: 'üè™ O que tem no mercado? Pense em boxes de comida e onde joalheiros trabalham...', 
              clue: 'üî® Ferramentas de ourives escondidas em um box de artesanato',
              collected: false
            },
            { 
              id: 'ev09', 
              location: 'praca-xv', 
              hint: 'üèõÔ∏è O que tem na pra√ßa? Pense na figueira centen√°ria e bancos ao redor...', 
              clue: 'üì± Celular abandonado com mensagens sobre "entrega √†s 22h"',
              collected: false
            }
          ]
        },
        { 
          id: 'caso04', 
          title: 'üöó Ve√≠culos Roubados', 
          desc: 'Carros desaparecendo em estacionamentos. V√° aos locais!', 
          difficulty: 'medium', 
          reward: 1100, 
          exp: 180,
          evidences: [
            { 
              id: 'ev10', 
              location: 'shopping-beiramar', 
              hint: 'üõçÔ∏è O que tem em um shopping? Pense em estacionamentos e c√¢meras de seguran√ßa...', 
              clue: 'üé• Imagens mostram dois homens com scanner de chaves eletr√¥nicas',
              collected: false
            },
            { 
              id: 'ev11', 
              location: 'aeroporto', 
              hint: '‚úàÔ∏è O que tem em um aeroporto? Pense em estacionamento de longa perman√™ncia...', 
              clue: 'üîë Chave micha adulterada encontrada no ch√£o',
              collected: false
            },
            { 
              id: 'ev12', 
              location: 'ufsc-campus', 
              hint: 'üéì O que tem em uma universidade? Pense em estacionamentos de alunos e professores...', 
              clue: 'üìã Lista com placas de carros de luxo grampeada em um mural',
              collected: false
            }
          ]
        },
        { 
          id: 'caso05', 
          title: 'üèñÔ∏è Assaltos na Praia', 
          desc: 'Turistas sendo assaltados nas praias. Investigue!', 
          difficulty: 'medium', 
          reward: 1000, 
          exp: 170,
          evidences: [
            { 
              id: 'ev13', 
              location: 'praia-mole', 
              hint: 'üèñÔ∏è O que tem na Praia Mole? Pense em quiosques e onde surfistas guardam suas coisas...', 
              clue: 'üéí Mochila rasgada com carteiras vazias jogada nas pedras',
              collected: false
            },
            { 
              id: 'ev14', 
              location: 'praia-joaquina', 
              hint: 'üèÑ O que tem na Joaquina? Pense em dunas e mirantes de onde se observa tudo...', 
              clue: 'üî≠ Bin√≥culos esquecidos no mirante - algu√©m vigiava os turistas',
              collected: false
            },
            { 
              id: 'ev15', 
              location: 'lagoa-orla', 
              hint: 'üåä O que tem na orla da Lagoa? Pense em quiosques e banheiros p√∫blicos...', 
              clue: 'üí≥ Cart√µes de cr√©dito encontrados em uma lixeira perto do banheiro',
              collected: false
            }
          ]
        }
      ];
    }

    function getLocationData() {
      return {
        'mercado-publico': { name: 'üè™ Mercado P√∫blico', address: 'Rua Conselheiro Mafra, 255, Centro', lat: -27.5949, lng: -48.5502 },
        'catedral': { name: '‚õ™ Catedral Metropolitana', address: 'Pra√ßa XV de Novembro, Centro', lat: -27.5969, lng: -48.5495 },
        'praca-xv': { name: 'üèõÔ∏è Pra√ßa XV de Novembro', address: 'Pra√ßa XV de Novembro, Centro', lat: -27.5969, lng: -48.5480 },
        'centrinho-lagoa': { name: 'üé™ Centrinho da Lagoa', address: 'Av. das Rendeiras, Lagoa da Concei√ß√£o', lat: -27.5969, lng: -48.4519 },
        'lagoa-orla': { name: 'üåä Orla da Lagoa', address: 'Orla da Lagoa da Concei√ß√£o', lat: -27.6000, lng: -48.4550 },
        'barra-lagoa': { name: 'üö§ Barra da Lagoa', address: 'Rod. Jo√£o Gualberto Soares, Barra da Lagoa', lat: -27.5742, lng: -48.4183 },
        'shopping-beiramar': { name: 'üõçÔ∏è Shopping Beiramar', address: 'Rua Bocai√∫va, 2468, Centro', lat: -27.5940, lng: -48.5519 },
        'aeroporto': { name: '‚úàÔ∏è Aeroporto', address: 'Av. Dep. Diom√≠cio Freitas, Carianos', lat: -27.6703, lng: -48.5472 },
        'ufsc-campus': { name: 'üéì Campus UFSC', address: 'Campus Universit√°rio, Trindade', lat: -27.6006, lng: -48.5197 },
        'praia-mole': { name: 'üèñÔ∏è Praia Mole', address: 'Praia Mole', lat: -27.6089, lng: -48.4319 },
        'praia-joaquina': { name: 'üèÑ Praia da Joaquina', address: 'Praia da Joaquina', lat: -27.6294, lng: -48.4453 }
      };
    }

    function startCase(caseId) {
      const allCases = getAllCases();
      const caseData = allCases.find(c => c.id === caseId);
      if (!caseData) return;

      if (!currentPlayer.activeCases) {
        currentPlayer.activeCases = {};
      }

      if (!currentPlayer.activeCases[caseId]) {
        currentPlayer.activeCases[caseId] = {
          id: caseId,
          startedAt: new Date().toISOString(),
          evidences: caseData.evidences.map(e => ({ ...e, collected: false }))
        };
        savePlayerData();
      }

      const activeCase = currentPlayer.activeCases[caseId];
      const totalEvidences = activeCase.evidences.length;
      const collectedCount = activeCase.evidences.filter(e => e.collected).length;
      const allCollected = collectedCount === totalEvidences;

      const canvas = document.getElementById('game-canvas');
      
      let evidencesHTML = activeCase.evidences.map((ev, index) => {
        const locationData = getLocationData()[ev.location];
        const status = ev.collected ? 
          '<div style="background: rgba(81,207,102,0.3); padding: 10px; border-radius: 8px; color: #51cf66; font-weight: 700; text-align: center;">‚úÖ COLETADA</div>' :
          '<div style="background: rgba(255,215,0,0.3); padding: 10px; border-radius: 8px; color: #ffd700; font-weight: 700; text-align: center;">üìç PENDENTE</div>';

        return `
          <div class="case-card" onclick='${ev.collected ? '' : `investigateEvidence("${caseId}", ${index})`}' style="${ev.collected ? '' : 'cursor: pointer;'}">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
              <div class="case-title" style="font-size: 16px;">üîç Evid√™ncia #${index + 1}</div>
            </div>
            
            ${ev.collected ? 
              `<div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 8px; margin: 10px 0;">
                <div style="color: #51cf66; font-size: 14px; font-weight: 700; margin-bottom: 5px;">‚úÖ DESCOBERTA:</div>
                <div style="color: #fff; font-size: 14px;">${ev.clue}</div>
              </div>` :
              `<div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 8px; margin: 10px 0;">
                <div style="color: #ffd700; font-size: 14px; font-weight: 700; margin-bottom: 5px;">üí° PISTA:</div>
                <div style="color: #fff; font-size: 14px;">${ev.hint}</div>
              </div>`
            }
            
            <div style="font-size: 12px; color: #ccc; margin: 10px 0;">
              üìç <strong>${locationData.name}</strong><br>
              ${locationData.address}
            </div>
            
            ${status}
          </div>
        `;
      }).join('');

      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">üîç</div>
          <div class="story-title">${caseData.title}</div>
          <span class="case-difficulty ${caseData.difficulty}" style="position: static; margin-bottom: 15px; display: inline-block;">${
            caseData.difficulty === 'easy' ? 'F√°cil' : 
            caseData.difficulty === 'medium' ? 'M√©dio' : 
            caseData.difficulty === 'hard' ? 'Dif√≠cil' : 'Extremo'
          }</span>
          
          <div class="story-text">
            <p>${caseData.desc}</p>
            <p style="color: #ffd700; margin-top: 10px;">üí∞ Recompensa: $${caseData.reward} | ‚≠ê +${caseData.exp} EXP</p>
          </div>

          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(74,144,226,0.3) 0%, rgba(53,122,189,0.3) 100%);">
            <div class="mystery-label">üìä PROGRESSO DO CASO</div>
            <div style="margin-top: 15px;">
              <div style="font-size: 24px; font-weight: 900; color: #ffd700; text-align: center; margin-bottom: 10px;">
                ${collectedCount} / ${totalEvidences} EVID√äNCIAS
              </div>
              <div class="progress-bar" style="height: 20px;">
                <div class="progress-fill" style="width: ${(collectedCount / totalEvidences) * 100}%; background: linear-gradient(90deg, #ffd700 0%, #ffa500 100%);">
                  ${Math.round((collectedCount / totalEvidences) * 100)}%
                </div>
              </div>
            </div>
          </div>

          ${allCollected ? `
            <div class="mystery-box" style="background: linear-gradient(135deg, rgba(81,207,102,0.3) 0%, rgba(55,178,77,0.3) 100%); border-color: #51cf66; margin-top: 15px;">
              <div class="mystery-label" style="color: #51cf66;">üéâ TODAS AS EVID√äNCIAS COLETADAS!</div>
              <div style="color: #fff; font-size: 16px; margin-top: 10px;">
                <p>Voc√™ encontrou todas as pistas! Hora de resolver o caso!</p>
              </div>
            </div>
          ` : ''}

          <div style="margin-top: 20px;">
            <h3 style="color: #ffd700; margin-bottom: 15px; text-align: center;">üó∫Ô∏è LOCAIS PARA INVESTIGAR</h3>
            <div style="display: grid; gap: 12px; max-height: 500px; overflow-y: auto;">
              ${evidencesHTML}
            </div>
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            ${allCollected ? 
              `<button class="choice-btn" onclick="solveCase('${caseId}')" style="background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: #fff;">
                üéØ RESOLVER O CASO
              </button>` : ''}
            <button class="choice-btn" onclick="abandonCase('${caseId}')">
              ‚ùå ABANDONAR CASO
            </button>
            <button class="choice-btn" onclick="openCaseFiles()">
              ‚¨ÖÔ∏è VOLTAR AOS CASOS
            </button>
          </div>
        </div>
      `;
    }

    function investigateEvidence(caseId, evidenceIndex) {
      const activeCase = currentPlayer.activeCases[caseId];
      const evidence = activeCase.evidences[evidenceIndex];
      
      if (evidence.collected) {
        showMessage('‚úÖ Voc√™ j√° coletou esta evid√™ncia!', 'info');
        return;
      }

      const locationData = getLocationData()[evidence.location];

      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">üîç</div>
          <div class="story-title">üîç Evid√™ncia #${evidenceIndex + 1}</div>
          
          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,165,0,0.3) 100%); border-color: #ffd700;">
            <div class="mystery-label">üí° PISTA</div>
            <div style="color: #fff; font-size: 16px; margin-top: 15px; line-height: 1.7;">
              ${evidence.hint}
            </div>
          </div>

          <div style="margin-top: 20px; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; border: 3px solid #4a90e2;">
            <div style="font-size: 18px; font-weight: 900; color: #ffd700; margin-bottom: 15px; text-align: center;">
              üìç LOCAL DA INVESTIGA√á√ÉO
            </div>
            <div style="color: #fff; font-size: 16px; text-align: center;">
              <p><strong>${locationData.name}</strong></p>
              <p style="font-size: 14px; color: #ccc; margin-top: 5px;">${locationData.address}</p>
            </div>
          </div>

          <div style="background: rgba(255,215,0,0.2); border: 2px solid #ffd700; border-radius: 10px; padding: 15px; margin-top: 15px;">
            <p style="color: #ffd700; font-weight: 700; font-size: 14px; text-align: center;">‚ö†Ô∏è VOC√ä PRECISA IR AT√â O LOCAL!</p>
            <p style="color: #fff; font-size: 13px; margin-top: 5px; text-align: center;">
              Voc√™ deve estar a menos de 500m do local para coletar a evid√™ncia.
            </p>
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            <button class="choice-btn" onclick="collectEvidenceWithGPS('${caseId}', ${evidenceIndex})" style="background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: #fff;">
              üìç FAZER CHECK-IN E COLETAR
            </button>
            <button class="choice-btn" onclick="startCase('${caseId}')">
              ‚¨ÖÔ∏è VOLTAR AO CASO
            </button>
          </div>
        </div>
      `;
    }

    function collectEvidenceWithGPS(caseId, evidenceIndex) {
      const activeCase = currentPlayer.activeCases[caseId];
      const evidence = activeCase.evidences[evidenceIndex];
      const locationData = getLocationData()[evidence.location];

      if (evidence.collected) {
        showMessage('‚úÖ Evid√™ncia j√° coletada!', 'info');
        return;
      }

      if (!navigator.geolocation) {
        showMessage('‚ùå Seu navegador n√£o suporta geolocaliza√ß√£o!', 'error');
        return;
      }

      showMessage('üìç Verificando sua localiza√ß√£o...', 'info');

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          const distance = calculateDistance(userLat, userLng, locationData.lat, locationData.lng);
          const maxDistance = 500;

          if (distance > maxDistance) {
            const distanceKm = (distance / 1000).toFixed(2);
            showMessage(`‚ùå Muito longe! Dist√¢ncia: ${distanceKm}km. Precisa estar a menos de 500m do local.`, 'error');
            return;
          }

          evidence.collected = true;
          currentPlayer.evidenceCollected = (currentPlayer.evidenceCollected || 0) + 1;
          savePlayerData();
          updateUI();

          showMessage(`‚úÖ Evid√™ncia coletada com sucesso!`, 'success');

          const canvas = document.getElementById('game-canvas');
          canvas.innerHTML = `
            <div class="story-panel">
              <div style="text-align: center; font-size: 80px; margin-bottom: 20px;">üéâ</div>
              <div class="story-title">‚úÖ EVID√äNCIA COLETADA!</div>
              
              <div class="story-text">
                <p>Voc√™ chegou ao local e encontrou algo importante!</p>
                <p style="color: #ffd700; font-size: 18px; margin-top: 10px;"><strong>${locationData.name}</strong></p>
              </div>

              <div class="mystery-box" style="background: linear-gradient(135deg, rgba(81,207,102,0.3) 0%, rgba(55,178,77,0.3) 100%); border-color: #51cf66;">
                <div class="mystery-label" style="color: #51cf66;">üîç O QUE VOC√ä ENCONTROU:</div>
                <div style="color: #fff; font-size: 18px; margin-top: 15px; line-height: 1.7; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px;">
                  ${evidence.clue}
                </div>
              </div>

              <div style="background: rgba(74,144,226,0.3); border: 2px solid #4a90e2; border-radius: 10px; padding: 15px; margin-top: 15px;">
                <p style="color: #4a90e2; font-weight: 700; font-size: 14px;">üìä Progresso:</p>
                <p style="color: #fff; font-size: 14px; margin-top: 5px;">
                  üîç Total de evid√™ncias coletadas no jogo: <strong style="color: #ffd700;">${currentPlayer.evidenceCollected}</strong>
                </p>
              </div>

              <div class="choices-container" style="margin-top: 25px;">
                <button class="choice-btn" onclick="startCase('${caseId}')" style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); color: #000;">
                  üîç CONTINUAR INVESTIGA√á√ÉO
                </button>
              </div>
            </div>
          `;
        },
        (error) => {
          let errorMsg = '‚ùå N√£o foi poss√≠vel obter sua localiza√ß√£o. ';
          if (error.code === error.PERMISSION_DENIED) {
            errorMsg += 'Permita o acesso √† localiza√ß√£o.';
          } else if (error.code === error.POSITION_UNAVAILABLE) {
            errorMsg += 'Localiza√ß√£o indispon√≠vel.';
          } else if (error.code === error.TIMEOUT) {
            errorMsg += 'Tempo esgotado. Tente novamente.';
          }
          showMessage(errorMsg, 'error');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function solveCase(caseId) {
      const allCases = getAllCases();
      const caseData = allCases.find(c => c.id === caseId);
      const activeCase = currentPlayer.activeCases[caseId];

      currentPlayer.money += caseData.reward;
      currentPlayer.exp += caseData.exp;
      currentPlayer.casesSolved = (currentPlayer.casesSolved || 0) + 1;
      currentPlayer.reputation += Math.floor(caseData.exp / 10);

      delete currentPlayer.activeCases[caseId];
      savePlayerData();
      updateUI();

      showMessage(`üéâ Caso resolvido! +$${caseData.reward} | +${caseData.exp} EXP`, 'success');

      const canvas = document.getElementById('game-canvas');
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 100px; margin-bottom: 20px;">üèÜ</div>
          <div class="story-title">üéâ CASO RESOLVIDO!</div>
          
          <div class="story-text">
            <p style="font-size: 20px; color: #ffd700; font-weight: 900;">PARAB√âNS, DETETIVE!</p>
            <p style="margin-top: 10px;">Voc√™ coletou todas as evid√™ncias e resolveu:</p>
            <p style="color: #ffd700; font-size: 18px; margin-top: 10px;"><strong>${caseData.title}</strong></p>
          </div>

          <div class="mystery-box" style="background: linear-gradient(135deg, rgba(81,207,102,0.3) 0%, rgba(55,178,77,0.3) 100%); border-color: #51cf66;">
            <div class="mystery-label" style="color: #51cf66;">üí∞ RECOMPENSAS RECEBIDAS</div>
            <div style="color: #fff; font-size: 20px; margin-top: 15px;">
              <p>üíµ Dinheiro: <strong style="color: #ffd700;">+$${caseData.reward}</strong></p>
              <p>‚≠ê Experi√™ncia: <strong style="color: #51cf66;">+${caseData.exp} EXP</strong></p>
              <p>üèÖ Reputa√ß√£o: <strong style="color: #4a90e2;">+${Math.floor(caseData.exp / 10)}</strong></p>
              <p>üîç Casos Resolvidos: <strong style="color: #fff;">${currentPlayer.casesSolved}</strong></p>
            </div>
          </div>

          <div style="background: rgba(255,215,0,0.2); border: 2px solid #ffd700; border-radius: 10px; padding: 15px; margin-top: 15px;">
            <div style="font-size: 16px; color: #ffd700; font-weight: 700; margin-bottom: 10px; text-align: center;">
              üìú RESUMO DAS EVID√äNCIAS
            </div>
            ${activeCase.evidences.map((ev, i) => `
              <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin: 8px 0;">
                <div style="color: #ffd700; font-size: 14px; font-weight: 700;">üîç Evid√™ncia #${i + 1}:</div>
                <div style="color: #fff; font-size: 13px; margin-top: 5px;">${ev.clue}</div>
              </div>
            `).join('')}
          </div>

          <div class="choices-container" style="margin-top: 25px;">
            <button class="choice-btn" onclick="openCaseFiles()" style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); color: #000;">
              üìÅ PR√ìXIMO CASO
            </button>
            <button class="choice-btn" onclick="loadWelcomeStory()">
              üè† VOLTAR AO IN√çCIO
            </button>
          </div>
        </div>
      `;
    }

    function abandonCase(caseId) {
      const allCases = getAllCases();
      const caseData = allCases.find(c => c.id === caseId);
      
      delete currentPlayer.activeCases[caseId];
      savePlayerData();
      
      showMessage(`‚ùå Caso "${caseData.title}" abandonado!`, 'info');
      setTimeout(() => openCaseFiles(), 1000);
    }

    function showCaseLocations() {
      showMessage('üó∫Ô∏è Navegue pelos casos primeiro!', 'info');
      openCaseFiles();
    }

    function openStudy() {
      const today = new Date().toDateString();
      if (currentPlayer.lastOnlineDate !== today) {
        currentPlayer.dailyStudyCompleted = false;
      }

      const canvas = document.getElementById('game-canvas');
      
      const studyStatus = currentPlayer.dailyStudyCompleted ? 
        '<div style="background: rgba(81,207,102,0.3); border: 2px solid #51cf66; border-radius: 10px; padding: 15px; margin-bottom: 15px;"><p style="color: #51cf66; font-weight: 700;">‚úÖ Voc√™ j√° completou sua miss√£o di√°ria de estudo hoje!</p><p style="color: #fff; font-size: 14px; margin-top: 5px;">Volte amanh√£ para estudar novamente.</p></div>' :
        '<div style="background: rgba(255,215,0,0.3); border: 2px solid #ffd700; border-radius: 10px; padding: 15px; margin-bottom: 15px;"><p style="color: #ffd700; font-weight: 700;">üìö Miss√£o Di√°ria Dispon√≠vel!</p><p style="color: #fff; font-size: 14px; margin-top: 5px;">VÔøΩÔøΩ at√© uma banca de revistas ou biblioteca para estudar casos antigos.</p></div>';

      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">üìö</div>
          <div class="story-title">üìö ESTUDAR CASOS ANTIGOS</div>
          <div class="story-text">
            <p>Estude casos antigos para aprimorar suas habilidades de investiga√ß√£o!</p>
            <p style="color: #4a90e2; margin-top: 10px;">Esta √© uma miss√£o di√°ria - pode ser feita 1 vez por dia.</p>
          </div>

          ${studyStatus}

          <div class="case-card" onclick="showStudyLocations()" style="cursor: pointer; background: linear-gradient(135deg, rgba(74,144,226,0.3) 0%, rgba(53,122,189,0.3) 100%);">
            <div class="case-title">üìñ IR ESTUDAR (COM GPS)</div>
            <div class="case-desc">V√° at√© uma banca de revistas ou biblioteca para estudar</div>
            <div style="margin-top: 10px; color: #ffd700;">
              üìç Requer localiza√ß√£o | üí∞ +$500 | ‚≠ê +100 EXP | üèÖ +20 Rep
            </div>
            ${currentPlayer.dailyStudyCompleted ? 
              '<div style="margin-top: 10px; padding: 10px; background: rgba(233,69,96,0.3); border-radius: 8px; color: #e94560; font-weight: 700; text-align: center;">‚ùå J√Å COMPLETADO HOJE</div>' : 
              '<div style="margin-top: 10px; padding: 10px; background: rgba(81,207,102,0.3); border-radius: 8px; color: #51cf66; font-weight: 700; text-align: center;">‚úÖ DISPON√çVEL</div>'}
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            <button class="choice-btn" onclick="loadWelcomeStory()">‚¨ÖÔ∏è VOLTAR</button>
          </div>
        </div>
      `;
    }

    function showStudyLocations() {
      if (currentPlayer.dailyStudyCompleted) {
        showMessage('‚ùå Voc√™ j√° completou sua miss√£o di√°ria de estudo!', 'error');
        return;
      }

      const locations = getStudyLocations();
      const canvas = document.getElementById('game-canvas');
      
      let locationsHTML = locations.map(loc => `
        <div class="case-card" onclick='completeStudy(${JSON.stringify(loc)})' style="cursor:pointer;">
          <div class="case-title">${loc.icon} ${loc.name}</div>
          <div class="case-desc" style="font-size: 12px; color: #ccc; margin-bottom: 10px;">
            üìç ${loc.address}
          </div>
          <div style="margin-top:10px;color:#51cf66;font-weight:700;">
            üí∞ +$500 | ‚≠ê +100 EXP | üèÖ +20 Rep
          </div>
        </div>
      `).join('');
      
      canvas.innerHTML = `
        <div class="story-panel">
          <div style="text-align: center; font-size: 60px; margin-bottom: 15px;">üìñ</div>
          <div class="story-title">ÔøΩÔøΩÔøΩ ONDE ESTUDAR HOJE?</div>
          <div class="story-text">
            <p>Escolha uma banca de revistas ou biblioteca para estudar!</p>
            <p style="color: #51cf66; font-size: 13px; margin-top: 10px;">‚ö†Ô∏è Voc√™ precisa estar a menos de 500m do local</p>
            <p style="color: #ffd700; font-size: 13px; margin-top: 5px;">üìö Miss√£o di√°ria - pode ser feita 1 vez por dia</p>
          </div>
          
          <div style="display: grid; gap: 15px; margin-top: 20px; max-height: 500px; overflow-y: auto;">
            ${locationsHTML}
          </div>

          <div class="choices-container" style="margin-top: 20px;">
            <button class="choice-btn" onclick="openStudy()">‚¨ÖÔ∏è VOLTAR</button>
          </div>
        </div>
      `;
    }

    function getStudyLocations() {
      return [
        // BANCAS DE REVISTAS
        {
          id: 'banca-centro-01',
          name: 'Banca de Revistas Centro',
          icon: 'üì∞',
          type: 'banca',
          address: 'Rua Felipe Schmidt, Centro',
          lat: -27.5949,
          lng: -48.5502
        },
        {
          id: 'banca-beiramar',
          name: 'Banca Shopping Beiramar',
          icon: 'üì∞',
          type: 'banca',
          address: 'Shopping Beiramar, Centro',
          lat: -27.5940,
          lng: -48.5519
        },
        {
          id: 'banca-trindade',
          name: 'Banca da Trindade',
          icon: 'üì∞',
          type: 'banca',
          address: 'Trindade, pr√≥ximo √† UFSC',
          lat: -27.6000,
          lng: -48.5200
        },
        {
          id: 'banca-lagoa',
          name: 'Banca Lagoa da Concei√ß√£o',
          icon: 'üì∞',
          type: 'banca',
          address: 'Centrinho da Lagoa',
          lat: -27.5969,
          lng: -48.4519
        },
        {
          id: 'banca-ingleses',
          name: 'Banca Ingleses',
          icon: 'üì∞',
          type: 'banca',
          address: 'Ingleses do Rio Vermelho',
          lat: -27.4400,
          lng: -48.3920
        },

        // BIBLIOTECAS (REUTILIZANDO AS MESMAS)
        {
          id: 'biblioteca-central-study',
          name: 'Biblioteca P√∫blica do Estado',
          icon: 'üìö',
          type: 'biblioteca',
          address: 'Rua Tenente Silveira, 343, Centro',
          lat: -27.5950,
          lng: -48.5510
        },
        {
          id: 'biblioteca-ufsc-study',
          name: 'Biblioteca Central UFSC',
          icon: 'üìö',
          type: 'biblioteca',
          address: 'Campus UFSC, Trindade',
          lat: -27.6006,
          lng: -48.5197
        },
        {
          id: 'biblioteca-lagoa-study',
          name: 'Biblioteca Comunit√°ria da Lagoa',
          icon: 'üìö',
          type: 'biblioteca',
          address: 'Lagoa da Concei√ß√£o',
          lat: -27.5980,
          lng: -48.4530
        },
        {
          id: 'biblioteca-ingleses-study',
          name: 'Biblioteca de Ingleses',
          icon: 'üìö',
          type: 'biblioteca',
          address: 'Ingleses do Rio Vermelho',
          lat: -27.4390,
          lng: -48.3917
        },
        {
          id: 'biblioteca-canasvieiras-study',
          name: 'Biblioteca de Canasvieiras',
          icon: 'üìö',
          type: 'biblioteca',
          address: 'Canasvieiras',
          lat: -27.4195,
          lng: -48.4578
        }
      ];
    }

    function completeStudy(location) {
      if (currentPlayer.dailyStudyCompleted) {
        showMessage('‚ùå Voc√™ j√° completou sua miss√£o di√°ria de estudo!', 'error');
        return;
      }

      if (!navigator.geolocation) {
        showMessage('‚ùå Seu navegador n√£o suporta geolocaliza√ß√£o!', 'error');
        return;
      }

      showMessage('üìç Verificando sua localiza√ß√£o...', 'info');

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          const distance = calculateDistance(userLat, userLng, location.lat, location.lng);
          const maxDistance = 500;

          if (distance > maxDistance) {
            const distanceKm = (distance / 1000).toFixed(2);
            showMessage(`‚ùå Muito longe! Dist√¢ncia: ${distanceKm}km. Precisa estar a menos de 500m.`, 'error');
            return;
          }

          currentPlayer.money += 500;
          currentPlayer.exp += 100;
          currentPlayer.reputation += 20;
          currentPlayer.dailyStudyCompleted = true;
          
          savePlayerData();
          updateUI();

          showMessage(`‚úÖ Estudo completado! +$500 | +100 EXP | +20 Rep`, 'success');

          const canvas = document.getElementById('game-canvas');
          canvas.innerHTML = `
            <div class="story-panel">
              <div style="text-align:center;font-size:80px;margin-bottom:20px;">üéì</div>
              <div class="story-title">‚úÖ ESTUDO COMPLETADO!</div>
              <div class="story-text">
                <p>Voc√™ estudou casos antigos e aprimorou suas habilidades!</p>
                <p style="color: #ffd700; font-size: 18px; margin-top: 10px;"><strong>${location.icon} ${location.name}</strong></p>
                <p style="color: #ccc; font-size: 14px; margin-top: 5px;">üìç ${location.address}</p>
              </div>

              <div class="mystery-box" style="background: linear-gradient(135deg, rgba(81,207,102,0.3) 0%, rgba(55,178,77,0.3) 100%); border-color: #51cf66;">
                <div class="mystery-label" style="color: #51cf66;">üí∞ RECOMPENSAS RECEBIDAS</div>
                <div style="color: #fff; font-size: 18px; margin-top: 15px;">
                  <p>üíµ Dinheiro: <strong style="color: #ffd700;">+$500</strong></p>
                  <p>‚≠ê Experi√™ncia: <strong style="color: #51cf66;">+100 EXP</strong></p>
                  <p>üèÖ Reputa√ß√£o: <strong style="color: #4a90e2;">+20</strong></p>
                </div>
              </div>

              <div style="background: rgba(74,144,226,0.3); border: 2px solid #4a90e2; border-radius: 10px; padding: 15px; margin-top: 15px;">
                <p style="color: #4a90e2; font-weight: 700;">üìÖ MISS√ÉO DI√ÅRIA COMPLETADA!</p>
                <p style="color: #fff; font-size: 14px; margin-top: 5px;">Volte amanh√£ para estudar novamente e ganhar mais recompensas!</p>
              </div>

              <div class="choices-container" style="margin-top:25px;">
                <button class="choice-btn" onclick="loadWelcomeStory()" style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); color: #000;">
                  üè† VOLTAR AO IN√çCIO
                </button>
              </div>
            </div>
          `;
        },
        (error) => {
          let errorMsg = '‚ùå N√£o foi poss√≠vel obter sua localiza√ß√£o. ';
          if (error.code === error.PERMISSION_DENIED) {
            errorMsg += 'Permita o acesso √† localiza√ß√£o.';
          } else if (error.code === error.POSITION_UNAVAILABLE) {
            errorMsg += 'Localiza√ß√£o indispon√≠vel.';
          } else if (error.code === error.TIMEOUT) {
            errorMsg += 'Tempo esgotado. Tente novamente.';
          }
          showMessage(errorMsg, 'error');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function openTeamManagement() {
      loadWelcomeStory();
    }

    function getRoleName(role) {
      const names = { 'detective': 'ÔøΩÔøΩÔøΩÔøΩÔ∏è Detetive', 'officer': 'üëÆ Policial', 'forensic': 'üî¨ Perito' };
      return names[role] || role;
    }

    function savePlayerData() {
      if (!currentPlayer) return;
      localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
      const allPlayers = JSON.parse(localStorage.getItem('players') || '[]');
      const index = allPlayers.findIndex(p => p.id === currentPlayer.id);
      if (index !== -1) {
        allPlayers[index] = currentPlayer;
        localStorage.setItem('players', JSON.stringify(allPlayers));
      }
    }

    function updateCurrentCaseDisplay() {
      const panel = document.getElementById('current-case-display');
      if (!panel) return;
      panel.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum caso ativo</p>';
    }

    function showMessage(text, type = 'info') {
      const existing = document.querySelector('.message-box');
      if (existing) existing.remove();
      
      const msg = document.createElement('div');
      msg.className = `message-box ${type}`;
      msg.textContent = text;
      document.body.appendChild(msg);
      
      setTimeout(() => msg.remove(), 4000);
    }

    function tryAutoLogin() {
      const saved = localStorage.getItem('currentPlayer');
      if (saved) {
        currentPlayer = JSON.parse(saved);
        allPlayers = JSON.parse(localStorage.getItem('players') || '[]');
        enterGame();
      }
    }

    function getWealthStatus(money) {
      if (money < 5000) return { text: 'üí∏ Pobre', color: '#e94560' };
      if (money < 20000) return { text: 'üí∞ Rico', color: '#ffd700' };
      return { text: 'ÔøΩÔøΩ Magnata', color: '#51cf66' };
    }

    function updateUI() {
      if (!currentPlayer) return;

      const wealthStatus = getWealthStatus(currentPlayer.money);
      document.getElementById('header-rank').textContent = wealthStatus.text;
      document.getElementById('header-rank').style.color = wealthStatus.color;
      
      document.getElementById('header-energy').textContent = currentPlayer.energy;
      document.getElementById('header-money').textContent = currentPlayer.money;
      document.getElementById('cases-solved').textContent = currentPlayer.casesSolved;
      document.getElementById('arrests-made').textContent = currentPlayer.arrestsMade;
      document.getElementById('evidence-collected').textContent = currentPlayer.evidenceCollected;
      document.getElementById('reputation').textContent = currentPlayer.reputation;
      document.getElementById('professor-stars').textContent = 'üéì ' + (currentPlayer.professorStars || 0);

      const expPercent = (currentPlayer.exp / (currentPlayer.level * 100)) * 100;
      const expBar = document.getElementById('exp-bar');
      expBar.style.width = expPercent + '%';
      expBar.textContent = currentPlayer.exp + '/' + (currentPlayer.level * 100);

      const energyPercent = (currentPlayer.energy / currentPlayer.maxEnergy) * 100;
      const energyBar = document.getElementById('energy-bar');
      energyBar.style.width = energyPercent + '%';
      energyBar.textContent = currentPlayer.energy + '/' + currentPlayer.maxEnergy;
      
      const wealthDisplay = document.getElementById('wealth-status-display');
      if (wealthDisplay) {
        wealthDisplay.textContent = wealthStatus.text;
        wealthDisplay.style.color = wealthStatus.color;
      }
      
      updateOnlineTime();
    }

    function loadWelcomeStory() {
      const canvas = document.getElementById('game-canvas');
      
      const studyBadge = currentPlayer.dailyStudyCompleted ? 
        '<span style="background: rgba(81,207,102,0.3); padding: 5px 10px; border-radius: 5px; color: #51cf66; font-size: 13px; margin-left: 10px;">‚úÖ Estudado hoje</span>' :
        '<span style="background: rgba(255,215,0,0.3); padding: 5px 10px; border-radius: 5px; color: #ffd700; font-size: 13px; margin-left: 10px;">üìö Dispon√≠vel</span>';

      canvas.innerHTML = `
        <div class="story-panel">
          <div class="story-title">ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ BEM-VINDO √Ä DELEGACIA</div>
          <div class="story-text">
            <p><strong>Detetive ${currentPlayer.name}</strong>, √© uma honra t√™-lo em nossa equipe!</p>
            <p>Voc√™ tem casos para investigar e turnos de trabalho dispon√≠veis!</p>
            <p style="color: #4a90e2; margin-top: 10px;">‚è±Ô∏è Tempo online hoje: <strong>${formatOnlineTime(currentPlayer.onlineTimeToday || 0)}</strong></p>
            <p style="color: #ffd700; margin-top: 10px;">üìö Miss√£o Di√°ria: ${studyBadge}</p>
          </div>

          <div class="choices-container">
            <button class="choice-btn" onclick="openCaseFiles()">üìÅ VER CASOS DISPON√çVEIS</button>
            <button class="choice-btn" onclick="openWorkShift()">üíº IR TRABALHAR</button>
            <button class="choice-btn" onclick="openStudy()">üìö ESTUDAR CASOS ANTIGOS</button>
            <button class="choice-btn" onclick="openRanking()">üèÜ VER RANKING</button>
          </div>
        </div>
      `;
    }

    function updateLoginClocks() {
      const now = new Date();
      const time = now.toLocaleTimeString('pt-BR');
      const date = now.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      
      const loginTime = document.getElementById('login-time');
      const loginDate = document.getElementById('login-date');
      const registerTime = document.getElementById('register-time');
      const registerDate = document.getElementById('register-date');
      
      if (loginTime) loginTime.textContent = time;
      if (loginDate) loginDate.textContent = date;
      if (registerTime) registerTime.textContent = time;
      if (registerDate) registerDate.textContent = date;
    }
    
    setInterval(updateLoginClocks, 1000);
    updateLoginClocks();

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a872f60719409d2',t:'MTc2NDgwODEyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
